<!doctype html><html lang=en-us><head><link rel=preload href=/lib/font-awesome/webfonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2 as=font type=font/woff2 crossorigin=anonymous><script type=text/javascript src=https://latest.cactus.chat/cactus.js></script>
<link rel=stylesheet href=https://latest.cactus.chat/style.css type=text/css><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>æ¢ç§˜è´Ÿè½½å‡è¡¡ | pinkhello</title><link rel=canonical href=https://pinkhello.cc/posts/36-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%9A%84%E6%80%9D%E8%80%83/><meta name=description content="ğŸ‘·Hey! æˆ‘æ˜¯ **pinkhello**ï¼ŒğŸ’» ä¸€ååç«¯ç¨‹åºå‘˜ã€‚**é‡è¦æç¤º**: åœ¨æ‚¨é˜…è¯»æ–‡ç« å¹¶è¯„è®ºä¹‹å‰ï¼Œè¯·å…ˆè®¤çœŸé˜…è¯»[**è¯„è®ºæ‰¿è¯º**](http://pinkhello.cc/promise)ã€‚"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><meta property="og:title" content="æ¢ç§˜è´Ÿè½½å‡è¡¡"><meta property="og:description" content="è´Ÿè½½å‡è¡¡"><meta property="og:type" content="article"><meta property="og:url" content="https://pinkhello.cc/posts/36-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%9A%84%E6%80%9D%E8%80%83/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-10-01T10:04:00+08:00"><meta property="article:modified_time" content="2021-10-01T10:04:00+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="æ¢ç§˜è´Ÿè½½å‡è¡¡"><meta name=twitter:description content="è´Ÿè½½å‡è¡¡"><link rel=stylesheet href=https://pinkhello.cc/css/styles.94f653e9e151e28067a7c5dbbc4600cbd5a3c721e79faaf971e523c40f3b249b8e4f20bb57810dfffa8d559ca5c140fd56eb4cd9c0853113ad08e66afdb08bdd.css integrity="sha512-lPZT6eFR4oBnp8XbvEYAy9WjxyHnn6r5ceUjxA87JJuOTyC7V4EN//qNVZylwUD9VutM2cCFMROtCOZq/bCL3Q=="><link rel=stylesheet href=https://pinkhello.cc/css/pinkhello.css><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script>
<script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel=icon type=image/png href=https://pinkhello.cc/images/favicon.ico><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","G-M2FXWC325L","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body class="max-width mx-auto px3 ltr"><div class="content index py4"><div id=header-post><a id=menu-icon href=#><i class="fas fa-bars fa-lg"></i></a>
<a id=menu-icon-tablet href=#><i class="fas fa-bars fa-lg"></i></a>
<a id=top-icon-tablet href=# onclick='$("html, body").animate({scrollTop:0},"fast")' style=display:none aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg"></i></a>
<span id=menu><span id=nav><ul><li><a href=/>Home</a></li><li><a href=/posts>Posts</a></li><li><a href=/categories>Category</a></li><li><a href=/tags>Tag</a></li><li><a href=/index.xml>Rss</a></li></ul></span><br><span id=actions><ul><li><a class=icon href=https://pinkhello.cc/posts/35-%E7%9F%AD%E9%93%BE%E6%8E%A5%E7%9A%84%E6%80%9D%E8%80%83%E4%B8%8E%E6%8A%80%E6%9C%AF%E5%AE%9E%E7%8E%B0/ aria-label=Previous><i class="fas fa-chevron-left" aria-hidden=true onmouseover='$("#i-prev").toggle()' onmouseout='$("#i-prev").toggle()'></i></a></li><li><a class=icon href=https://pinkhello.cc/posts/40-mvcc%E5%9C%A8%E4%B8%8D%E5%90%8C%E7%9A%84%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B9%8B%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8/ aria-label=Next><i class="fas fa-chevron-right" aria-hidden=true onmouseover='$("#i-next").toggle()' onmouseout='$("#i-next").toggle()'></i></a></li><li><a class=icon href=# onclick='$("html, body").animate({scrollTop:0},"fast")' aria-label="Top of Page"><i class="fas fa-chevron-up" aria-hidden=true onmouseover='$("#i-top").toggle()' onmouseout='$("#i-top").toggle()'></i></a></li><li><a class=icon href=# aria-label=Share><i class="fas fa-share-alt" aria-hidden=true onmouseover='$("#i-share").toggle()' onmouseout='$("#i-share").toggle()' onclick='return $("#share").toggle(),!1'></i></a></li></ul><span id=i-prev class=info style=display:none>Previous post</span>
<span id=i-next class=info style=display:none>Next post</span>
<span id=i-top class=info style=display:none>Back to top</span>
<span id=i-share class=info style=display:none>Share post</span></span><br><div id=share style=display:none><ul><li><a class=icon href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fpinkhello.cc%2fposts%2f36-%25E8%25B4%259F%25E8%25BD%25BD%25E5%259D%2587%25E8%25A1%25A1%25E7%259A%2584%25E6%2580%259D%25E8%2580%2583%2f" aria-label=Facebook><i class="fab fa-facebook" aria-hidden=true></i></a></li><li><a class=icon href="https://twitter.com/share?url=https%3a%2f%2fpinkhello.cc%2fposts%2f36-%25E8%25B4%259F%25E8%25BD%25BD%25E5%259D%2587%25E8%25A1%25A1%25E7%259A%2584%25E6%2580%259D%25E8%2580%2583%2f&text=%e6%8e%a2%e7%a7%98%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1" aria-label=Twitter><i class="fab fa-twitter" aria-hidden=true></i></a></li><li><a class=icon href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fpinkhello.cc%2fposts%2f36-%25E8%25B4%259F%25E8%25BD%25BD%25E5%259D%2587%25E8%25A1%25A1%25E7%259A%2584%25E6%2580%259D%25E8%2580%2583%2f&title=%e6%8e%a2%e7%a7%98%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1" aria-label=Linkedin><i class="fab fa-linkedin" aria-hidden=true></i></a></li><li><a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fpinkhello.cc%2fposts%2f36-%25E8%25B4%259F%25E8%25BD%25BD%25E5%259D%2587%25E8%25A1%25A1%25E7%259A%2584%25E6%2580%259D%25E8%2580%2583%2f&is_video=false&description=%e6%8e%a2%e7%a7%98%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1" aria-label=Pinterest><i class="fab fa-pinterest" aria-hidden=true></i></a></li><li><a class=icon href="mailto:?subject=%e6%8e%a2%e7%a7%98%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1&body=Check out this article: https%3a%2f%2fpinkhello.cc%2fposts%2f36-%25E8%25B4%259F%25E8%25BD%25BD%25E5%259D%2587%25E8%25A1%25A1%25E7%259A%2584%25E6%2580%259D%25E8%2580%2583%2f" aria-label=Email><i class="fas fa-envelope" aria-hidden=true></i></a></li><li><a class=icon href="https://getpocket.com/save?url=https%3a%2f%2fpinkhello.cc%2fposts%2f36-%25E8%25B4%259F%25E8%25BD%25BD%25E5%259D%2587%25E8%25A1%25A1%25E7%259A%2584%25E6%2580%259D%25E8%2580%2583%2f&title=%e6%8e%a2%e7%a7%98%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1" aria-label=Pocket><i class="fab fa-get-pocket" aria-hidden=true></i></a></li><li><a class=icon href="http://reddit.com/submit?url=https%3a%2f%2fpinkhello.cc%2fposts%2f36-%25E8%25B4%259F%25E8%25BD%25BD%25E5%259D%2587%25E8%25A1%25A1%25E7%259A%2584%25E6%2580%259D%25E8%2580%2583%2f&title=%e6%8e%a2%e7%a7%98%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1" aria-label=reddit><i class="fab fa-reddit" aria-hidden=true></i></a></li><li><a class=icon href="http://www.tumblr.com/share/link?url=https%3a%2f%2fpinkhello.cc%2fposts%2f36-%25E8%25B4%259F%25E8%25BD%25BD%25E5%259D%2587%25E8%25A1%25A1%25E7%259A%2584%25E6%2580%259D%25E8%2580%2583%2f&name=%e6%8e%a2%e7%a7%98%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1&description=%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1" aria-label=Tumblr><i class="fab fa-tumblr" aria-hidden=true></i></a></li><li><a class=icon href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fpinkhello.cc%2fposts%2f36-%25E8%25B4%259F%25E8%25BD%25BD%25E5%259D%2587%25E8%25A1%25A1%25E7%259A%2584%25E6%2580%259D%25E8%2580%2583%2f&t=%e6%8e%a2%e7%a7%98%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1" aria-label="Hacker News"><i class="fab fa-hacker-news" aria-hidden=true></i></a></li></ul></div></span></div><article class=post itemscope itemtype=http://schema.org/BlogPosting><header><h1 class=posttitle itemprop="name headline">æ¢ç§˜è´Ÿè½½å‡è¡¡</h1><div class=meta><div class=postdate><time datetime="2021-10-01 10:04:00 +0800 +0800" itemprop=datePublished>2021-10-01</time></div><div class=article-category><i class="fas fa-archive"></i>
<a class=category-link href=/categories/tech>Tech</a></div><div class=article-tag><i class="fas fa-tag"></i>
<a class=tag-link href=/tags/load-balance rel=tag>load balance</a>
,
<a class=tag-link href=/tags/golang rel=tag>golang</a>
,
<a class=tag-link href=/tags/dubbo rel=tag>dubbo</a>
,
<a class=tag-link href=/tags/grpc rel=tag>Grpc</a></div></div></header><div id=toc><nav id=TableOfContents><ul><li><a href=#ä¸ºä»€ä¹ˆè¦è´Ÿè½½å‡è¡¡>ä¸ºä»€ä¹ˆè¦è´Ÿè½½å‡è¡¡</a></li><li><a href=#è´Ÿè½½å‡è¡¡çš„ç®—æ³•>è´Ÿè½½å‡è¡¡çš„ç®—æ³•</a></li><li><a href=#å¸¸ç”¨çš„è´Ÿè½½å‡è¡¡æ‰‹æ®µ>å¸¸ç”¨çš„è´Ÿè½½å‡è¡¡æ‰‹æ®µ</a><ul><li><a href=#ä»£ç†æ¨¡å¼>ä»£ç†æ¨¡å¼</a></li><li><a href=#é‡å®¢æˆ·ç«¯æ¨¡å¼>é‡å®¢æˆ·ç«¯æ¨¡å¼</a></li><li><a href=#å¤–éƒ¨è´Ÿè½½å‡è¡¡æ¨¡å¼-é‡æœåŠ¡ç«¯-è½»å®¢æˆ·ç«¯>å¤–éƒ¨è´Ÿè½½å‡è¡¡æ¨¡å¼ (é‡æœåŠ¡ç«¯ è½»å®¢æˆ·ç«¯)</a></li></ul></li></ul><ul><li><a href=#è´Ÿè½½å‡è¡¡çš„å‡è¡¡æ–¹å¼>è´Ÿè½½å‡è¡¡çš„å‡è¡¡æ–¹å¼</a><ul><li></li></ul></li></ul></nav></div><div class=content itemprop=articleBody><h1 id=å‰è¨€>å‰è¨€</h1><p>ä»Šå¤©æ˜¯å›½åº†çš„ç¬¬3å¤©ï¼Œåœ¨æ­¤æ­ç¥å°å“¥å“¥å’Œå°å§å§ä»¬â›±ï¸èŠ‚æ—¥å¿«ä¹ï¼ å¾®ä¿¡æœ‹å‹åœˆğŸ€„ï¸å…¨éƒ¨æ˜¯ æ—…é€”INGã€‚</p><p>æˆ‘çš„å›½åº†ï¼š</p><ul><li>ç¬¬ä¸€å¤©: å¸¦ğŸª†</li><li>ç¬¬äºŒå¤©: è¢«å¯ä¸œå‘äº†ä¸€å›</li><li>ç¬¬ä¸‰å¤©: ğŸˆšï¸å­©ä¸€èº«è½»</li><li>&mldr;&mldr;</li></ul><p>å¯¹äºæˆ‘è¿™ç§ç¤¾äº¤å°´å°¬è€…ï¼Œâ›±ï¸åº¦å‡æœ€å¥½çš„æ–¹å¼è¿˜æ˜¯å­¦ä¹ ã€‚</p><p>ä»Šæ—¥å¸¦æ¥äº† è‡ªå·±å¯¹äºè´Ÿè½½å‡è¡¡(load balance)çš„å­¦ä¹ ã€‚</p><h1 id=åº¦å‡æœ€å¥½çš„æ–¹å¼æ˜¯å­¦ä¹ >åº¦å‡æœ€å¥½çš„æ–¹å¼æ˜¯å­¦ä¹ </h1><p>GRPCåœ¨è´Ÿè½½å‡è¡¡çš„è®¾è®¡: <a href=https://github.com/grpc/grpc/blob/master/doc/load-balancing.md>Load-balancing.md</a></p><h2 id=ä¸ºä»€ä¹ˆè¦è´Ÿè½½å‡è¡¡>ä¸ºä»€ä¹ˆè¦è´Ÿè½½å‡è¡¡</h2><p>åœ¨å¦‚ä»Šçš„äº’è”ç½‘é¢†åŸŸï¼Œå¯¹äºæ•°æ®çš„å¤§çˆ†å‘ï¼Œé«˜é¢‘çš„è¯·æ±‚ï¼Œå¯¹äºæä¾›æœåŠ¡çš„ä¼ä¸šæ¥è¯´æ˜¯ä¸å°çš„ITèµ„æºå¼€é”€ã€‚ä¸ºäº†è§£å†³èµ„æºä¸­çš„è´Ÿè½½åˆ†é…ï¼Œå¹¶ä¸”ä½¿å¾—èµ„æºçš„åˆ©ç”¨ç‡è¾¾åˆ°æœ€å¤§ã€‚å‡ºç°äº†è´Ÿè½½å‡è¡¡ï¼Œä¸»è¦ä¸ºäº†è§£å†³ é«˜å¹¶å‘ å’Œ é«˜å¯ç”¨ã€‚</p><p>è´Ÿè½½å‡è¡¡çš„å®ç°æ–¹å¼æœ‰ï¼šè½¯ä»¶ å’Œ ç¡¬ä»¶ã€‚è¿™æ¬¡æˆ‘å­¦ä¹ çš„ä¸»æ˜¯è½¯ä»¶æ–¹å¼ã€‚</p><h2 id=è´Ÿè½½å‡è¡¡çš„ç®—æ³•>è´Ÿè½½å‡è¡¡çš„ç®—æ³•</h2><ul><li>è½®è¯¢( Round Robin ) & åŠ æƒè½®è¯¢( Weight Round Robin ) :</li><li>éšæœº & åŠ æƒéšæœº</li><li>æœ€å°‘è¿æ¥( Last Connections ) : é€šè¿‡å°†æµé‡å¼•å¯¼åˆ°ç¬¬ä¸€ä¸ªå¯ç”¨æœåŠ¡å™¨ç„¶åå°†è¯¥æœåŠ¡å™¨ç§»åŠ¨åˆ°é˜Ÿåˆ—åº•éƒ¨æ¥è½®æ¢æœåŠ¡å™¨ï¼Œå½“æœåŠ¡å™¨å…·æœ‰ç›¸åŒçš„è§„æ ¼å¹¶ä¸”æ²¡æœ‰å¾ˆå¤šæŒä¹…è¿æ¥æ—¶æœ€æœ‰ç”¨ã€‚</li><li>å“ˆå¸Œ( Hash ) eg: ip hash</li><li>ä¸€è‡´æ€§å“ˆå¸Œ( Consistent Hash ) eg: request_url ä¸€è‡´æ€§å“ˆå¸Œ</li><li>æœ€å°‘å“åº”æ—¶é—´ : å°†æµé‡å®šå‘åˆ°æ´»åŠ¨è¿æ¥æœ€å°‘ä¸”å¹³å‡å“åº”æ—¶é—´æœ€çŸ­çš„æœåŠ¡å™¨ã€‚</li></ul><h2 id=å¸¸ç”¨çš„è´Ÿè½½å‡è¡¡æ‰‹æ®µ>å¸¸ç”¨çš„è´Ÿè½½å‡è¡¡æ‰‹æ®µ</h2><p><a href=https://github.com/grpc/grpc/blob/master/doc/load-balancing.md>Load-balancing.md</a> å·²ç»ä»‹ç»äº†ä»¥ä¸‹å‡ ç§</p><h3 id=ä»£ç†æ¨¡å¼>ä»£ç†æ¨¡å¼</h3><blockquote><p>ä»£ç†æ¨¡å¼éœ€è¦å¯é çš„å¹¶ä¸”èƒ½æŠ¥å‘Šè´Ÿè½½åˆ°è´Ÿè½½å‡è¡¡çš„ç³»ç»Ÿçš„å®¢æˆ·ç«¯ï¼Œè¿™ç§éœ€è¦é¢å¤–çš„èµ„æºæ¥å¤„ç†ã€å¹¶ä¸”è´Ÿè½½å‡è¡¡ç³»ç»ŸåŒ…å«äº†æ¯ä¸ªRPCè¯·æ±‚å’Œå“åº”çš„å‰¯æœ¬ï¼Œå¢åŠ äº†æœåŠ¡å»¶è¿Ÿ</p></blockquote><h3 id=é‡å®¢æˆ·ç«¯æ¨¡å¼>é‡å®¢æˆ·ç«¯æ¨¡å¼</h3><blockquote><p>è¿™ç§æ–¹å¼ã€æ˜¯ç»å¤§éƒ¨åˆ†è´Ÿè½½å‡è¡¡çš„é€»è¾‘æ”¾ç½®åœ¨å®¢æˆ·ç«¯ã€‚( å¯ä»¥ä»åˆ—è¡¨é‡é€‰æ‹©æœåŠ¡å™¨çš„è´Ÿè½½å‡è¡¡ç­–ç•¥(å¾ªç¯ã€éšæœºç­‰)ï¼ŒæœåŠ¡å™¨åˆ—è¡¨è¦ä¹ˆé…ç½®çš„ã€è¦ä¹ˆç”±å…¶ä»–æœåŠ¡æä¾›ã€ä¸¾ä¸ªä¾‹å­ï¼šæ¯”å¦‚ kafkaã€pulsarã€redis ç­‰ç­‰é›†ç¾¤æ¨¡å¼çš„å®¢æˆ·ç«¯ )
è¿™ç§æ¨¡å¼éœ€è¦å·²å¤šç§è¯­è¨€çš„æ–¹å¼æä¾›è´Ÿè½½å‡è¡¡ç­–ç•¥ã€è¿™ç§å¢åŠ äº†å®¢æˆ·ç«¯ä»£ç çš„å¤æ‚æ€§ã€‚</p></blockquote><h3 id=å¤–éƒ¨è´Ÿè½½å‡è¡¡æ¨¡å¼-é‡æœåŠ¡ç«¯-è½»å®¢æˆ·ç«¯>å¤–éƒ¨è´Ÿè½½å‡è¡¡æ¨¡å¼ (é‡æœåŠ¡ç«¯ è½»å®¢æˆ·ç«¯)</h3><blockquote><p>å®¢æˆ·ç«¯ä¿æŒç®€å•ã€å¹¶ä¸”å¯ä»¥éå¸¸ç®€å•å¯ç§»æ¤ã€‚å®ç°ç”¨äºæœåŠ¡å™¨é€‰æ‹©çš„è‘—åç®—æ³•ã€‚å¤æ‚çš„è´Ÿè½½å¹³è¡¡ç®—æ³•ç”±è´Ÿè½½å‡è¡¡å™¨æä¾›ï¼Œå®¢æˆ·ç«¯ä»…ä»…éœ€è¦ä»è´Ÿè½½å‡è¡¡å™¨æä¾›çš„é…ç½®å’ŒæœåŠ¡å™¨åˆ—è¡¨é‡Œé¢é€‰æ‹©ï¼Œå¹¶å‘å®ƒä»¬å‘é€å®¢æˆ·ç«¯çš„è¯·æ±‚ã€‚è´Ÿè½½å‡è¡¡å™¨éœ€è¦ä»è¿™äº›æœåŠ¡å™¨åˆ—è¡¨ä¸­é€‰å–å‡ºå¥åº·è´Ÿè½½çš„æœåŠ¡å™¨å’Œå‰”å‡ºä¸å¯ç”¨æœåŠ¡å™¨ã€‚åœ¨è´Ÿè½½å‡è¡¡å™¨åšå‡ºé€‰ä¸¾å’Œå…¶ä»–å†³ç­–çš„æ—¶å€™éœ€è¦é€šçŸ¥åˆ°å®¢æˆ·ç«¯åšæ›´æ–°ã€‚è´Ÿè½½å‡è¡¡å™¨å¯ä»¥ä»åç«¯æœåŠ¡ä¸­æ”¶é›†è´Ÿè½½å’Œå¥åº·ä¿¡æ¯ã€‚</p></blockquote><h1 id=è´Ÿè½½å‡è¡¡-ä¸-ssl>è´Ÿè½½å‡è¡¡ ä¸ SSL</h1><p>æˆ‘ä»¬éƒ½çŸ¥é“ SSL æ˜¯ç”¨äº WebæœåŠ¡å™¨ å’Œ æµè§ˆå™¨ ä¹‹é—´çš„å»ºç«‹åŠ å¯†é“¾æ¥çš„æ ‡å‡†çš„å®‰å…¨æŠ€æœ¯æ–¹å¼ï¼ŒSSL æµé‡é€šå¸¸åœ¨è´Ÿè½½å‡è¡¡å™¨ä¸Šè¿›è¡Œè§£å¯†ï¼Œå½“è´Ÿè½½å‡è¡¡å™¨åœ¨ä¼ é€’è¯·æ±‚ä¹‹å‰è§£å¯†æµé‡æˆ–è¯·æ±‚çš„æ—¶å€™ï¼Œå«åš SSL ç»ˆæ­¢ã€‚è´Ÿè½½å‡è¡¡å™¨ä½¿å¾— Web æœåŠ¡å™¨ä¸éœ€è¦èŠ±è´¹é¢å¤–çš„èµ„æºæ¥è¿›è¡Œè§£å¯†æ“ä½œã€‚
ä½†è¿™æ ·ä¹Ÿå¸¦æ¥äº†ä¸€å®šçš„å®‰å…¨é£é™©ï¼Œä¸€èˆ¬åœ¨åŒä¸€ä¸ªæ•°æ®ä¸­å¿ƒçš„ï¼Œé£é™©ä¼šä½ä¸€äº›ï¼Œè¿™æ˜¯ä¸€ç§è§£å†³æ–¹å¼ï¼›ç¬¬äºŒç§çš„è¯å°±æ˜¯ SSL pass-throughï¼Œå°±æ˜¯ è´Ÿè½½å‡è¡¡å™¨ ä»…ä»…å°†åŠ å¯†çš„è¯·æ±‚ä¼ é€’åˆ° WebæœåŠ¡å™¨ï¼Œç„¶åé€šè¿‡WebæœåŠ¡å™¨è¿›è¡Œè§£å¯†ï¼Œå…¶ä»–éæ³•è¯·æ±‚è¿›è¡Œæ‹¦æˆªã€‚</p><h1 id=è´Ÿè½½å‡è¡¡çš„å¥½å¤„>è´Ÿè½½å‡è¡¡çš„å¥½å¤„</h1><p>è´Ÿè½½å‡è¡¡æ˜¯ä¸€ä¸ªç½‘ç»œæµé‡ç›‘æ§çš„ğŸ‘®â€çš„è§’è‰²ï¼Œè´Ÿè½½å‡è¡¡å·¥ä½œä¸ OSI (åº”ã€è¡¨ã€ä¼šã€ä¼ ã€ç½‘ã€æ•°ã€ç‰©)ï¼Œçš„ 4 åˆ° 7 å±‚</p><ul><li>L4: æ ¹æ®ç½‘ç»œå’Œä¼ è¾“å±‚åè®®çš„æ•°æ®(IP å’Œ TCP ç«¯å£)å¼•å¯¼æµé‡</li><li>L7: å°†å†…å®¹åˆ‡æ¢åˆ°è´Ÿè½½å‡è¡¡ä¸Šå», è¯¸å¦‚ HTTP æ ‡å¤´ï¼Œ REQUEST URLï¼ŒSSL ä¼šè¯ç­‰ç­‰</li></ul><h1 id=å›å¤´çœ‹-è´Ÿè½½å‡è¡¡-åœ¨-å¾®æœåŠ¡æ¶æ„ä½“ç³»-é‡Œé¢çš„åº”ç”¨>å›å¤´çœ‹ è´Ÿè½½å‡è¡¡ åœ¨ å¾®æœåŠ¡æ¶æ„ä½“ç³» é‡Œé¢çš„åº”ç”¨</h1><p>å¾€å¾€åœ¨å¾®æœåŠ¡æ¶æ„ä½“ç³»é‡Œé¢ï¼Œè´Ÿè½½å‡è¡¡ å½’å±åº”ç”¨äº æœåŠ¡æ³¨å†Œä¸å‘ç° è¿™ä¸€å¤§ç¯èŠ‚å†…çš„ã€‚åœ¨å¼•å…¥å¾®æœåŠ¡æ¶æ„ï¼Œå¾€å¾€ä¼´éšçš„æ˜¯é›†ç¾¤éƒ¨ç½²ç¯å¢ƒï¼Œè¿™è¾¹å°±éœ€è¦è€ƒè™‘åˆ°æœåŠ¡å®¹é”™æ€§ã€æœåŠ¡çš„è‡ªåŠ¨æ³¨å†Œã€æœåŠ¡çš„è‡ªåŠ¨å‘ç°ã€‚</p><h2 id=è´Ÿè½½å‡è¡¡çš„å‡è¡¡æ–¹å¼>è´Ÿè½½å‡è¡¡çš„å‡è¡¡æ–¹å¼</h2><ul><li>Proxy eg: nginx or envoy</li><li>Client Side eg: grpc or dubbo</li></ul><h4 id=dubbo-å†…éƒ¨çš„-è´Ÿè½½å‡è¡¡-å®ç°>Dubbo å†…éƒ¨çš„ è´Ÿè½½å‡è¡¡ å®ç°</h4><p><a href=https://dubbo.apache.org/zh/>Dubbo</a></p><p>æ­¤æ¬¡æŸ¥é˜…æ˜¯åŸºäº Apache Dubbo 3.0 ç‰ˆæœ¬è¿›è¡Œçš„æºç é˜…è¯»ä¸åˆ†æï¼Œå…¶æ ¸å¿ƒè®¾è®¡å…¶å®è¿˜æœ‰ route ç¯‡å¹…æœ‰é™ï¼Œä¸åšä»‹ç»ã€‚(åé¢ä¼šä¸“é—¨å‡ºä¸€è®²è®²è¿° Apache Dubbo 3.0 çš„è´´åˆäº‘åŸç”Ÿçš„æœåŠ¡æ¶æ„æ¨¡å‹è®¾è®¡)ã€‚</p><p>å¦‚å›¾ï¼Œå®ç°äº† éšæœºã€è½®è¯¢ã€ä¸€è‡´æ€§å“ˆå¸Œã€æœ€å°‘æ´»è·ƒè°ƒç”¨æ•°</p><p><img src=/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%9A%84%E6%80%9D%E8%80%83/dubbo-3.0-loadbalance.jpg alt=dubbo-go-3.0è´Ÿè½½å‡è¡¡ä»£ç ç›®å½•></p><p>æ ¸å¿ƒä»£ç è§£æ:</p><p><code>doubbo-go/cluster/loadbalance.go</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// LoadBalance
</span></span></span><span style=display:flex><span><span style=color:#75715e>// Extension - LoadBalance  å®šä¹‰äº†ä¸€ä¸ªè´Ÿè½½å‡è¡¡çš„æ¥å£ï¼Œå…¶ä»–ä»£ç çœç•¥
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>LoadBalance</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span><span style=color:#a6e22e>Select</span>([]<span style=color:#a6e22e>protocol</span>.<span style=color:#a6e22e>Invoker</span>, <span style=color:#a6e22e>protocol</span>.<span style=color:#a6e22e>Invocation</span>) <span style=color:#a6e22e>protocol</span>.<span style=color:#a6e22e>Invoker</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>æƒé‡éšæœº
<code>doubbo-go/cluster/loadbalance/random.go</code> çœ‹å…¶å®ç°çš„ Select æ–¹æ³•</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>lb</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>randomLoadBalance</span>) <span style=color:#a6e22e>Select</span>(<span style=color:#a6e22e>invokers</span> []<span style=color:#a6e22e>protocol</span>.<span style=color:#a6e22e>Invoker</span>, <span style=color:#a6e22e>invocation</span> <span style=color:#a6e22e>protocol</span>.<span style=color:#a6e22e>Invocation</span>) <span style=color:#a6e22e>protocol</span>.<span style=color:#a6e22e>Invoker</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>length</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// åˆ¤æ–­ Invoker æ•°é‡ï¼Œå¦‚æœåªæœ‰ä¸€ä¸ªç›´æ¥è¿”å›
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>length</span> = len(<span style=color:#a6e22e>invokers</span>); <span style=color:#a6e22e>length</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>invokers</span>[<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#75715e>// éå† Invokers è®¡ç®— TotalWeight å’Œ SameWeight
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// å¦‚æœ TotalWeight &gt; 0 å¹¶ä¸” SameWeight ä¸º false åˆ™éšæœºä¸€ä¸ª offsetï¼Œ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// ç„¶åéå† weightsï¼Œåº”offsetæŒ¨ä¸ªå‡å» weight å å°äº0ï¼Œåˆ™è¿™ä¸ªä½ç½®çš„ invoker è¢«é€‰ä¸­ï¼Œ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// å¦‚æœéƒ½æ²¡é€‰ä¸­ï¼Œåˆ™ä» invokers åˆ—è¡¨é‡Œé¢ éšæœºè¿”å›ä¸€ä¸ª 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>sameWeight</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>weights</span> <span style=color:#f92672>:=</span> make([]<span style=color:#66d9ef>int64</span>, <span style=color:#a6e22e>length</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>firstWeight</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>GetWeight</span>(<span style=color:#a6e22e>invokers</span>[<span style=color:#ae81ff>0</span>], <span style=color:#a6e22e>invocation</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>totalWeight</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>firstWeight</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>weights</span>[<span style=color:#ae81ff>0</span>] = <span style=color:#a6e22e>firstWeight</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>1</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#a6e22e>length</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>weight</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>GetWeight</span>(<span style=color:#a6e22e>invokers</span>[<span style=color:#a6e22e>i</span>], <span style=color:#a6e22e>invocation</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>weights</span>[<span style=color:#a6e22e>i</span>] = <span style=color:#a6e22e>weight</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>totalWeight</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>weight</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>sameWeight</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>weight</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>firstWeight</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>sameWeight</span> = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>totalWeight</span> &gt; <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> !<span style=color:#a6e22e>sameWeight</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// If (not every invoker has the same weight &amp; at least one invoker&#39;s weight&gt;0), select randomly based on totalWeight.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>offset</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rand</span>.<span style=color:#a6e22e>Int63n</span>(<span style=color:#a6e22e>totalWeight</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#a6e22e>length</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>offset</span> <span style=color:#f92672>-=</span> <span style=color:#a6e22e>weights</span>[<span style=color:#a6e22e>i</span>]
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>offset</span> &lt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>invokers</span>[<span style=color:#a6e22e>i</span>]
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#75715e>// If all invokers have the same weight value or totalWeight=0, return evenly.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>invokers</span>[<span style=color:#a6e22e>rand</span>.<span style=color:#a6e22e>Intn</span>(<span style=color:#a6e22e>length</span>)]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>è½®è¯¢</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Select gets invoker based on round robin load balancing strategy
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>lb</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>roundRobinLoadBalance</span>) <span style=color:#a6e22e>Select</span>(<span style=color:#a6e22e>invokers</span> []<span style=color:#a6e22e>protocol</span>.<span style=color:#a6e22e>Invoker</span>, <span style=color:#a6e22e>invocation</span> <span style=color:#a6e22e>protocol</span>.<span style=color:#a6e22e>Invocation</span>) <span style=color:#a6e22e>protocol</span>.<span style=color:#a6e22e>Invoker</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>count</span> <span style=color:#f92672>:=</span> len(<span style=color:#a6e22e>invokers</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>count</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>count</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>invokers</span>[<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ç»„è£…KEY
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>key</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>invokers</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>GetURL</span>().<span style=color:#a6e22e>Path</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;.&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>invocation</span>.<span style=color:#a6e22e>MethodName</span>()
</span></span><span style=display:flex><span>	<span style=color:#75715e>// æ ¹æ®KEYä»ç¼“å­˜ä¸­è·å–ï¼Œæ²¡æœ‰å°±å­˜èµ·æ¥
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>cache</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>methodWeightMap</span>.<span style=color:#a6e22e>LoadOrStore</span>(<span style=color:#a6e22e>key</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>cachedInvokers</span>{})
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>cachedInvokers</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>cache</span>.(<span style=color:#f92672>*</span><span style=color:#a6e22e>cachedInvokers</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> (
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>clean</span>               = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>totalWeight</span>         = int64(<span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>maxCurrentWeight</span>    = int64(<span style=color:#a6e22e>math</span>.<span style=color:#a6e22e>MinInt64</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>now</span>                 = <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>()
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>selectedInvoker</span>     <span style=color:#a6e22e>protocol</span>.<span style=color:#a6e22e>Invoker</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>selectedWeightRobin</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>weightedRoundRobin</span>
</span></span><span style=display:flex><span>	)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// éå† Invokers 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>invoker</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>invokers</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>weight</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>GetWeight</span>(<span style=color:#a6e22e>invoker</span>, <span style=color:#a6e22e>invocation</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>weight</span> &lt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>weight</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>        <span style=color:#75715e>// å°† url è½¬æ¢æˆèº«ä»½æ ‡è¯†
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>identifier</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>invoker</span>.<span style=color:#a6e22e>GetURL</span>().<span style=color:#a6e22e>Key</span>()
</span></span><span style=display:flex><span>		<span style=color:#75715e>// ä»mapä¸­è·å–ï¼Œæ²¡æœ‰å°±å­˜èµ·æ¥
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>loaded</span>, <span style=color:#a6e22e>found</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>cachedInvokers</span>.<span style=color:#a6e22e>LoadOrStore</span>(<span style=color:#a6e22e>identifier</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>weightedRoundRobin</span>{<span style=color:#a6e22e>weight</span>: <span style=color:#a6e22e>weight</span>})
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>weightRobin</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>loaded</span>.(<span style=color:#f92672>*</span><span style=color:#a6e22e>weightedRoundRobin</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>found</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>clean</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>weightRobin</span>.<span style=color:#a6e22e>Weight</span>() <span style=color:#f92672>!=</span> <span style=color:#a6e22e>weight</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>weightRobin</span>.<span style=color:#a6e22e>setWeight</span>(<span style=color:#a6e22e>weight</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>currentWeight</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>weightRobin</span>.<span style=color:#a6e22e>increaseCurrent</span>()
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>weightRobin</span>.<span style=color:#a6e22e>lastUpdate</span> = <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>now</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// å¦‚æœå½“å‰æƒé‡ &gt; max 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>currentWeight</span> &gt; <span style=color:#a6e22e>maxCurrentWeight</span> {
</span></span><span style=display:flex><span>		    <span style=color:#75715e>// max è®¾ç½®æˆèµ‹å€¼å½“å‰æƒé‡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>maxCurrentWeight</span> = <span style=color:#a6e22e>currentWeight</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>selectedInvoker</span> = <span style=color:#a6e22e>invoker</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>selectedWeightRobin</span> = <span style=color:#a6e22e>weightRobin</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>totalWeight</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>weight</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å½“ invoker åˆ—è¡¨ ä¸ ç¼“å­˜çš„Invoker(å³ Mapå¤§å°) å¤§å°ä¸ä¸€è‡´çš„æ—¶å€™ï¼Œå°±éœ€è¦æ¸…ç†ç¼“å­˜ä¸­çš„æ•°æ®
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// è¶…è¿‡ recyclePeriod æ—¶é—´æ²¡æœ‰æ›´æ–°è¿‡çš„ åšæ¸…ç†åŠ¨ä½œ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>cleanIfRequired</span>(<span style=color:#a6e22e>clean</span>, <span style=color:#a6e22e>cachedInvokers</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>now</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å¦‚æœé€‰ä¸­çš„ invoker çš„ weightedRoundRobin ä¸ä¸ºç©ºï¼Œ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// åˆ™å°† weightedRoundRobin çš„ crurent è®¾ç½®ä¸º è´Ÿçš„ totalWeight
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// ç„¶å è¿”å› é€‰ä¸­çš„ invoker
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// è¿™è¾¹ä¸ºä»€ä¹ˆè®¾ç½®ä¸ºè´Ÿçš„ï¼š ï¼ˆæ˜¯ä¸æ˜¯æ„Ÿè§‰è®¾è®¡çš„ç²¾å¦™ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>//    totalWeight ä¸ºæ‰€æœ‰çš„æƒé‡çš„å’Œï¼Œè¿™æ¬¡é€‰ä¸­äº†è¿™ä¸ªï¼Œè¿™ä¸ªå˜æˆäº†è´Ÿçš„
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>//    ä¸‹è½®è‚¯å®šè½®ä¸åˆ°è¿™ä¸ª invoker å› ä¸ºä»–çš„æƒé‡æ˜¯æœ€å°çš„ï¼Œåé¢æ‰€æœ‰çš„éƒ½è¢«é€‰ä¸­çš„äº†ä¸€æ¬¡ï¼Œé‚£ä¹ˆæ‰€æœ‰çš„å…¨å˜æˆè´Ÿçš„äº†
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>//    ä¸‹æ¬¡å†é€‰ä¸¾çš„æ—¶å€™ï¼Œå†ä»è´Ÿçš„é‡Œé¢æ‰¾åˆ°æœ€å¤§çš„ï¼Œæ‰€ä»¥åˆä¸€æ¬¡è¢«é€‰ä¸­ï¼Œè¿™æ ·åˆå˜æˆæ­£æ•°äº†ã€‚
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>selectedWeightRobin</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>selectedWeightRobin</span>.<span style=color:#a6e22e>Current</span>(<span style=color:#a6e22e>totalWeight</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>selectedInvoker</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ä¸Šé¢ä¸€è½®ä¸‹æ¥å•¥éƒ½æ²¡æœ‰ï¼Œé‚£å°±é€‰æ‹©ç¬¬ä¸€ä¸ª
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// should never happen
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>invokers</span>[<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>cleanIfRequired</span>(<span style=color:#a6e22e>clean</span> <span style=color:#66d9ef>bool</span>, <span style=color:#a6e22e>invokers</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>cachedInvokers</span>, <span style=color:#a6e22e>now</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>clean</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>CompareAndSwapInt32</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>state</span>, <span style=color:#a6e22e>COMPLETE</span>, <span style=color:#a6e22e>UPDATING</span>) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>CompareAndSwapInt32</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>state</span>, <span style=color:#a6e22e>UPDATING</span>, <span style=color:#a6e22e>COMPLETE</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>invokers</span>.<span style=color:#a6e22e>Range</span>(<span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>identify</span>, <span style=color:#a6e22e>robin</span> <span style=color:#66d9ef>interface</span>{}) <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>weightedRoundRobin</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>robin</span>.(<span style=color:#f92672>*</span><span style=color:#a6e22e>weightedRoundRobin</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>elapsed</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>now</span>.<span style=color:#a6e22e>Sub</span>(<span style=color:#f92672>*</span><span style=color:#a6e22e>weightedRoundRobin</span>.<span style=color:#a6e22e>lastUpdate</span>).<span style=color:#a6e22e>Nanoseconds</span>()
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>elapsed</span> &gt; <span style=color:#a6e22e>recyclePeriod</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>invokers</span>.<span style=color:#a6e22e>Delete</span>(<span style=color:#a6e22e>identify</span>)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>		})
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Record the weight of the invoker
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>weightedRoundRobin</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æƒé‡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>weight</span>     <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>current</span>    <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// æœ€åä¿®æ”¹æ—¶é—´
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>lastUpdate</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>robin</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>weightedRoundRobin</span>) <span style=color:#a6e22e>Weight</span>() <span style=color:#66d9ef>int64</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>LoadInt64</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>robin</span>.<span style=color:#a6e22e>weight</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>robin</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>weightedRoundRobin</span>) <span style=color:#a6e22e>setWeight</span>(<span style=color:#a6e22e>weight</span> <span style=color:#66d9ef>int64</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>robin</span>.<span style=color:#a6e22e>weight</span> = <span style=color:#a6e22e>weight</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>robin</span>.<span style=color:#a6e22e>current</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>robin</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>weightedRoundRobin</span>) <span style=color:#a6e22e>increaseCurrent</span>() <span style=color:#66d9ef>int64</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>AddInt64</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>robin</span>.<span style=color:#a6e22e>current</span>, <span style=color:#a6e22e>robin</span>.<span style=color:#a6e22e>weight</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>robin</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>weightedRoundRobin</span>) <span style=color:#a6e22e>Current</span>(<span style=color:#a6e22e>delta</span> <span style=color:#66d9ef>int64</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>AddInt64</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>robin</span>.<span style=color:#a6e22e>current</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>*</span><span style=color:#a6e22e>delta</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ç¼“å­˜ï¼Œ key = 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>cachedInvokers</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Map</span> <span style=color:#75715e>/*[string]weightedRoundRobin*/</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>ä¸€è‡´æ€§å“ˆå¸Œ</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Select gets invoker based on load balancing strategy
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>lb</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>consistentHashLoadBalance</span>) <span style=color:#a6e22e>Select</span>(<span style=color:#a6e22e>invokers</span> []<span style=color:#a6e22e>protocol</span>.<span style=color:#a6e22e>Invoker</span>, <span style=color:#a6e22e>invocation</span> <span style=color:#a6e22e>protocol</span>.<span style=color:#a6e22e>Invocation</span>) <span style=color:#a6e22e>protocol</span>.<span style=color:#a6e22e>Invoker</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>methodName</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>invocation</span>.<span style=color:#a6e22e>MethodName</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>key</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>invokers</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>GetURL</span>().<span style=color:#a6e22e>ServiceKey</span>() <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;.&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>methodName</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// éå†æ•´ä¸ª invoker åˆ—è¡¨, æŒ¨ä¸ªæ‰§è¡Œ json.Marshal æ“ä½œï¼Œç„¶åå°† bytes[] æ·»åŠ åˆ°bsä¸­
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// é€šè¿‡ crc32.ChecksumIEEE(bs) è®¡ç®— hashCode, å¯¹æ¯” selectors ä¸­çš„ key æ˜¯å¦ä¸€è‡´ï¼Œä¸€è‡´é€‰ä¸­ï¼Œ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// ä¸ä¸€è‡´åˆ™é€šè¿‡ newConsistentHashSelector é‡æ–°è®¾ç½®ä¸€ä¸ª 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    
</span></span><span style=display:flex><span>	<span style=color:#75715e>// hash the invokers
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>bs</span> <span style=color:#f92672>:=</span> make([]<span style=color:#66d9ef>byte</span>, <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>invoker</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>invokers</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>b</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>Marshal</span>(<span style=color:#a6e22e>invoker</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>bs</span> = append(<span style=color:#a6e22e>bs</span>, <span style=color:#a6e22e>b</span><span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>hashCode</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>crc32</span>.<span style=color:#a6e22e>ChecksumIEEE</span>(<span style=color:#a6e22e>bs</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>selector</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>selectors</span>[<span style=color:#a6e22e>key</span>]
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>ok</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>selector</span>.<span style=color:#a6e22e>hashCode</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>hashCode</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>selectors</span>[<span style=color:#a6e22e>key</span>] = <span style=color:#a6e22e>newConsistentHashSelector</span>(<span style=color:#a6e22e>invokers</span>, <span style=color:#a6e22e>methodName</span>, <span style=color:#a6e22e>hashCode</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>selector</span> = <span style=color:#a6e22e>selectors</span>[<span style=color:#a6e22e>key</span>]
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>selector</span>.<span style=color:#a6e22e>Select</span>(<span style=color:#a6e22e>invocation</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// å®šäºäº† hashCodeã€replicaNumã€virtualInvokers ç­‰ç­‰å‚æ•°
</span></span></span><span style=display:flex><span><span style=color:#75715e>// consistentHashSelector implementation of Selector:get invoker based on load balancing strategy
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>consistentHashSelector</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>hashCode</span>        <span style=color:#66d9ef>uint32</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>replicaNum</span>      <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>virtualInvokers</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>uint32</span>]<span style=color:#a6e22e>protocol</span>.<span style=color:#a6e22e>Invoker</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>keys</span>            <span style=color:#a6e22e>gxsort</span>.<span style=color:#a6e22e>Uint32Slice</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>argumentIndex</span>   []<span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#75715e>// ..... åé¢çš„ä»£ç çœç•¥
</span></span></span></code></pre></div><h4 id=grpc-å†…éƒ¨çš„-è´Ÿè½½å‡è¡¡-å®ç°>GRPC å†…éƒ¨çš„ è´Ÿè½½å‡è¡¡ å®ç°</h4><p><a href=https://www.grpc.io/>GRPC</a></p><p>GRPC å®šä¹‰äº† è´Ÿè½½å‡è¡¡çš„å·¥ä½œæµç¨‹ å’Œ æ¥å£</p><p><img src=/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%9A%84%E6%80%9D%E8%80%83/grpc-load-balancing.png alt=grpc-load-balancing></p><ul><li>å®¢æˆ·ç«¯æœåŠ¡åœ¨å¯åŠ¨çš„æ—¶å€™ï¼Œé¦–å…ˆæ ¹æ® Name Resolver å»è§£æï¼Œè§£ææˆæ˜¯ LB åœ°å€ è¿˜æ˜¯ IPåˆ—è¡¨åœ°å€ã€‚ï¼ˆè¿™ä¸ªIPåˆ—è¡¨ï¼Œæ ‡è®°è¿™ä¸ªè¿™ä¸ªæ˜¯æœåŠ¡å™¨åœ°å€è¿˜æ˜¯LBåœ°å€ï¼Œå¯¹äºè¯·æ±‚çš„å®¢æˆ·ç«¯çš„è´Ÿè½½å‡è¡¡ç­–ç•¥å’ŒæœåŠ¡é…ç½®ç­‰ï¼‰</li><li>å®¢æˆ·ç«¯æ ¹æ®è¿”å›ï¼Œå®ä¾‹åŒ–è¯·æ±‚ç­–ç•¥( LB çš„è¯ ä½¿ç”¨ grpclb ç­–ç•¥ï¼Œå¦åˆ™ å®¢æˆ·ç«¯ä½¿ç”¨æœåŠ¡é…ç½®çš„è¯·æ±‚çš„è´Ÿè½½å‡è¡¡ç­–ç•¥)</li><li>è´Ÿè½½å‡è¡¡ç­–ç•¥ä¸ºæ¯ä¸ªæœåŠ¡å™¨åœ°å€åˆ›å»ºä¸€ä¸ª Channel</li><li>å½“æœ‰è¯·æ±‚çš„æ—¶å€™ï¼Œè´Ÿè½½å‡è¡¡ç­–ç•¥å†³å®šä½¿ç”¨å“ªä¸ªå­é€šé“ã€‚</li></ul><p><img src=/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%9A%84%E6%80%9D%E8%80%83/grpc-go-balance.jpg alt=grpc-goè´Ÿè½½å‡è¡¡ä»£ç ç›®å½•></p><p><code>grpc-go/balancer/base/base.go</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// PickerBuilder creates balancer.Picker.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>PickerBuilder</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Build returns a picker that will be used by gRPC to pick a SubConn.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>Build</span>(<span style=color:#a6e22e>info</span> <span style=color:#a6e22e>PickerBuildInfo</span>) <span style=color:#a6e22e>balancer</span>.<span style=color:#a6e22e>Picker</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>grpc-go/balancer/balancer.go</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Picker</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Pick returns the connection to use for this RPC and related information.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// Pick should not block.  If the balancer needs to do I/O or any blocking
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// or time-consuming work to service this call, it should return
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// ErrNoSubConnAvailable, and the Pick call will be repeated by gRPC when
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// the Picker is updated (using ClientConn.UpdateState).
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// If an error is returned:
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// - If the error is ErrNoSubConnAvailable, gRPC will block until a new
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>//   Picker is provided by the balancer (using ClientConn.UpdateState).
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// - If the error is a status error (implemented by the grpc/status
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>//   package), gRPC will terminate the RPC with the code and message
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>//   provided.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// - For all other errors, wait for ready RPCs will wait, but non-wait for
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>//   ready RPCs will be terminated with this error&#39;s Error() string and
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>//   status code Unavailable.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>Pick</span>(<span style=color:#a6e22e>info</span> <span style=color:#a6e22e>PickInfo</span>) (<span style=color:#a6e22e>PickResult</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>grpc-go/balancer/base/balancer.go</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>errPicker</span>) <span style=color:#a6e22e>Pick</span>(<span style=color:#a6e22e>info</span> <span style=color:#a6e22e>balancer</span>.<span style=color:#a6e22e>PickInfo</span>) (<span style=color:#a6e22e>balancer</span>.<span style=color:#a6e22e>PickResult</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>balancer</span>.<span style=color:#a6e22e>PickResult</span>{}, <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>è½®è¯¢
<code>grpc-go/balancer/roundrobin/roundrobin.go</code></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>rrPickerBuilder</span> <span style=color:#66d9ef>struct</span>{}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Builder æ“ä½œï¼Œå½“GRPC æœ‰èŠ‚ç‚¹æ›´æ–°çš„æ—¶å€™
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#f92672>*</span><span style=color:#a6e22e>rrPickerBuilder</span>) <span style=color:#a6e22e>Build</span>(<span style=color:#a6e22e>info</span> <span style=color:#a6e22e>base</span>.<span style=color:#a6e22e>PickerBuildInfo</span>) <span style=color:#a6e22e>balancer</span>.<span style=color:#a6e22e>Picker</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Infof</span>(<span style=color:#e6db74>&#34;roundrobinPicker: Build called with info: %v&#34;</span>, <span style=color:#a6e22e>info</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>info</span>.<span style=color:#a6e22e>ReadySCs</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>base</span>.<span style=color:#a6e22e>NewErrPicker</span>(<span style=color:#a6e22e>balancer</span>.<span style=color:#a6e22e>ErrNoSubConnAvailable</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>scs</span> <span style=color:#f92672>:=</span> make([]<span style=color:#a6e22e>balancer</span>.<span style=color:#a6e22e>SubConn</span>, <span style=color:#ae81ff>0</span>, len(<span style=color:#a6e22e>info</span>.<span style=color:#a6e22e>ReadySCs</span>))
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>sc</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>info</span>.<span style=color:#a6e22e>ReadySCs</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>scs</span> = append(<span style=color:#a6e22e>scs</span>, <span style=color:#a6e22e>sc</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>rrPicker</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>subConns</span>: <span style=color:#a6e22e>scs</span>,
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Start at a random index, as the same RR balancer rebuilds a new
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// picker when SubConn states change, and we don&#39;t want to apply excess
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// load to the first server in the list.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>next</span>: <span style=color:#a6e22e>grpcrand</span>.<span style=color:#a6e22e>Intn</span>(len(<span style=color:#a6e22e>scs</span>)),
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>rrPicker</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// subConns is the snapshot of the roundrobin balancer when this picker was
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// created. The slice is immutable. Each Get() will do a round robin
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// selection from it and return the selected SubConn.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>subConns</span> []<span style=color:#a6e22e>balancer</span>.<span style=color:#a6e22e>SubConn</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>mu</span>   <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Mutex</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>next</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// å¼€å§‹é€‰æ‹©äº†æ“ä½œäº† æŒ‘é€‰èŠ‚ç‚¹
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>rrPicker</span>) <span style=color:#a6e22e>Pick</span>(<span style=color:#a6e22e>balancer</span>.<span style=color:#a6e22e>PickInfo</span>) (<span style=color:#a6e22e>balancer</span>.<span style=color:#a6e22e>PickResult</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>sc</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>subConns</span>[<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>next</span>]
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>next</span> = (<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>next</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>%</span> len(<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>subConns</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>balancer</span>.<span style=color:#a6e22e>PickResult</span>{<span style=color:#a6e22e>SubConn</span>: <span style=color:#a6e22e>sc</span>}, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>åŠ æƒè½®è¯¢
<code>grpc-go/balancer/weightedroundrobin/weightedroundrobin.go</code></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// attributeKey is the type used as the key to store AddrInfo in the Attributes
</span></span></span><span style=display:flex><span><span style=color:#75715e>// field of resolver.Address.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>attributeKey</span> <span style=color:#66d9ef>struct</span>{}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// AddrInfo will be stored inside Address metadata in order to use weighted
</span></span></span><span style=display:flex><span><span style=color:#75715e>// roundrobin balancer.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>AddrInfo</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Weight</span> <span style=color:#66d9ef>uint32</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// SetAddrInfo returns a copy of addr in which the Attributes field is updated
</span></span></span><span style=display:flex><span><span style=color:#75715e>// with addrInfo.
</span></span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>// Experimental
</span></span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>// Notice: This API is EXPERIMENTAL and may be changed or removed in a
</span></span></span><span style=display:flex><span><span style=color:#75715e>// later release.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>SetAddrInfo</span>(<span style=color:#a6e22e>addr</span> <span style=color:#a6e22e>resolver</span>.<span style=color:#a6e22e>Address</span>, <span style=color:#a6e22e>addrInfo</span> <span style=color:#a6e22e>AddrInfo</span>) <span style=color:#a6e22e>resolver</span>.<span style=color:#a6e22e>Address</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>addr</span>.<span style=color:#a6e22e>Attributes</span> = <span style=color:#a6e22e>addr</span>.<span style=color:#a6e22e>Attributes</span>.<span style=color:#a6e22e>WithValues</span>(<span style=color:#a6e22e>attributeKey</span>{}, <span style=color:#a6e22e>addrInfo</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>addr</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// GetAddrInfo returns the AddrInfo stored in the Attributes fields of addr.
</span></span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>// Experimental
</span></span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>// Notice: This API is EXPERIMENTAL and may be changed or removed in a
</span></span></span><span style=display:flex><span><span style=color:#75715e>// later release.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>GetAddrInfo</span>(<span style=color:#a6e22e>addr</span> <span style=color:#a6e22e>resolver</span>.<span style=color:#a6e22e>Address</span>) <span style=color:#a6e22e>AddrInfo</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>v</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>addr</span>.<span style=color:#a6e22e>Attributes</span>.<span style=color:#a6e22e>Value</span>(<span style=color:#a6e22e>attributeKey</span>{})
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ai</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>v</span>.(<span style=color:#a6e22e>AddrInfo</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ai</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=envoy-è´Ÿè½½å‡è¡¡>Envoy è´Ÿè½½å‡è¡¡</h4><p><a href=https://www.envoyproxy.io/docs/envoy/latest/intro/intro>Envoy</a></p><ul><li>è½®è¯¢</li><li>åŠ æƒæœ€å°‘è¯·æ±‚</li><li>ç¯å“ˆå¸Œ(ä¸€è‡´æ€§å“ˆå¸Œ)</li><li>Maglev</li><li>éšæœº</li><li>IPå“ˆå¸Œ</li><li>ä¼˜å…ˆçº§åˆ’åˆ†</li></ul><p>è¿™è¾¹é¢„ç•™æ€è€ƒæ¢è®¨äº†ï½ï½ï½ å‘è¯»è€…å»äº†è§£ä¸€ä¸‹ Envoy å¦‚ä½•å®ç°è¿™äº›çš„è´Ÿè½½å‡è¡¡æ–¹å¼çš„ï¼Ÿ</p><p>å‚è€ƒæ–‡æ¡£</p><ul><li>GRPC è´Ÿè½½å‡è¡¡ <a href=https://github.com/grpc/grpc/blob/master/doc/load-balancing.md>https://github.com/grpc/grpc/blob/master/doc/load-balancing.md</a></li><li>Dubbo 3.0 <a href=https://dubbo.apache.org/zh/>https://dubbo.apache.org/zh/</a></li><li>GRPC <a href=https://www.grpc.io/>https://www.grpc.io/</a></li></ul></div></article><div class=blog-post-comments><div id=disqus_thread><script type=text/javascript>(function(){var t,e=document.createElement("script");e.type="text/javascript",e.async=!0,t="pinkhello",e.src="//"+t+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com/ class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div><div id=footer-post-container><div id=footer-post><div id=nav-footer style=display:none><ul><li><a href=/>Home</a></li><li><a href=/posts>Posts</a></li><li><a href=/categories>Category</a></li><li><a href=/tags>Tag</a></li><li><a href=/index.xml>Rss</a></li></ul></div><div id=share-footer style=display:none><ul><li><a class=icon href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fpinkhello.cc%2fposts%2f36-%25E8%25B4%259F%25E8%25BD%25BD%25E5%259D%2587%25E8%25A1%25A1%25E7%259A%2584%25E6%2580%259D%25E8%2580%2583%2f" aria-label=Facebook><i class="fab fa-facebook fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://twitter.com/share?url=https%3a%2f%2fpinkhello.cc%2fposts%2f36-%25E8%25B4%259F%25E8%25BD%25BD%25E5%259D%2587%25E8%25A1%25A1%25E7%259A%2584%25E6%2580%259D%25E8%2580%2583%2f&text=%e6%8e%a2%e7%a7%98%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1" aria-label=Twitter><i class="fab fa-twitter fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fpinkhello.cc%2fposts%2f36-%25E8%25B4%259F%25E8%25BD%25BD%25E5%259D%2587%25E8%25A1%25A1%25E7%259A%2584%25E6%2580%259D%25E8%2580%2583%2f&title=%e6%8e%a2%e7%a7%98%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1" aria-label=Linkedin><i class="fab fa-linkedin fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fpinkhello.cc%2fposts%2f36-%25E8%25B4%259F%25E8%25BD%25BD%25E5%259D%2587%25E8%25A1%25A1%25E7%259A%2584%25E6%2580%259D%25E8%2580%2583%2f&is_video=false&description=%e6%8e%a2%e7%a7%98%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1" aria-label=Pinterest><i class="fab fa-pinterest fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="mailto:?subject=%e6%8e%a2%e7%a7%98%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1&body=Check out this article: https%3a%2f%2fpinkhello.cc%2fposts%2f36-%25E8%25B4%259F%25E8%25BD%25BD%25E5%259D%2587%25E8%25A1%25A1%25E7%259A%2584%25E6%2580%259D%25E8%2580%2583%2f" aria-label=Email><i class="fas fa-envelope fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://getpocket.com/save?url=https%3a%2f%2fpinkhello.cc%2fposts%2f36-%25E8%25B4%259F%25E8%25BD%25BD%25E5%259D%2587%25E8%25A1%25A1%25E7%259A%2584%25E6%2580%259D%25E8%2580%2583%2f&title=%e6%8e%a2%e7%a7%98%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1" aria-label=Pocket><i class="fab fa-get-pocket fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://reddit.com/submit?url=https%3a%2f%2fpinkhello.cc%2fposts%2f36-%25E8%25B4%259F%25E8%25BD%25BD%25E5%259D%2587%25E8%25A1%25A1%25E7%259A%2584%25E6%2580%259D%25E8%2580%2583%2f&title=%e6%8e%a2%e7%a7%98%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1" aria-label=reddit><i class="fab fa-reddit fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.tumblr.com/share/link?url=https%3a%2f%2fpinkhello.cc%2fposts%2f36-%25E8%25B4%259F%25E8%25BD%25BD%25E5%259D%2587%25E8%25A1%25A1%25E7%259A%2584%25E6%2580%259D%25E8%2580%2583%2f&name=%e6%8e%a2%e7%a7%98%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1&description=%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1" aria-label=Tumblr><i class="fab fa-tumblr fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fpinkhello.cc%2fposts%2f36-%25E8%25B4%259F%25E8%25BD%25BD%25E5%259D%2587%25E8%25A1%25A1%25E7%259A%2584%25E6%2580%259D%25E8%2580%2583%2f&t=%e6%8e%a2%e7%a7%98%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1" aria-label="Hacker News"><i class="fab fa-hacker-news fa-lg" aria-hidden=true></i></a></li></ul></div><div id=actions-footer><a id=menu-toggle class=icon href=# onclick='return $("#nav-footer").toggle(),!1' aria-label=Menu><i class="fas fa-bars fa-lg" aria-hidden=true></i> Menu</a>
<a id=share-toggle class=icon href=# onclick='return $("#share-footer").toggle(),!1' aria-label=Share><i class="fas fa-share-alt fa-lg" aria-hidden=true></i> share</a>
<a id=top style=display:none class=icon href=# onclick='$("html, body").animate({scrollTop:0},"fast")' aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg" aria-hidden=true></i> Top</a></div></div></div><footer id=footer><div class=footer-left>Copyright &copy; 2022 pinkhello</div><div class=footer-right><nav><ul><li><a href=/>Home</a></li><li><a href=/posts>Posts</a></li><li><a href=/categories>Category</a></li><li><a href=/tags>Tag</a></li><li><a href=/index.xml>Rss</a></li></ul></nav></div></footer></div></body><link rel=stylesheet href=/lib/font-awesome/css/all.min.css><script src=/lib/jquery/jquery.min.js></script>
<script src=/js/main.js></script>
<script src=/js/code-copy.js></script>
<script>MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]]},svg:{fontCache:"global"}}</script><script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script></html>