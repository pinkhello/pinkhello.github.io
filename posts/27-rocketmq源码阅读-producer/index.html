<!doctype html><html lang=en-us><head><link rel=preload href=/lib/font-awesome/webfonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2 as=font type=font/woff2 crossorigin=anonymous><script type=text/javascript src=https://latest.cactus.chat/cactus.js></script>
<link rel=stylesheet href=https://latest.cactus.chat/style.css type=text/css><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>RocketMQæºç é˜…è¯» Producer | pinkhello</title><link rel=canonical href=https://pinkhello.cc/posts/27-rocketmq%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-producer/><meta name=description content="ğŸ‘·Hey! æˆ‘æ˜¯ **pinkhello**ï¼ŒğŸ’» ä¸€ååç«¯ç¨‹åºå‘˜ã€‚**é‡è¦æç¤º**: åœ¨æ‚¨é˜…è¯»æ–‡ç« å¹¶è¯„è®ºä¹‹å‰ï¼Œè¯·å…ˆè®¤çœŸé˜…è¯»[**è¯„è®ºæ‰¿è¯º**](http://pinkhello.cc/promise)ã€‚"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><meta property="og:title" content="RocketMQæºç é˜…è¯» Producer"><meta property="og:description" content="RocketMQå¼€ç®±æºç è¯¦è§£-Producer-æˆ‘å°±æ˜¯ä¸ªæ‰“å·¥äºº"><meta property="og:type" content="article"><meta property="og:url" content="https://pinkhello.cc/posts/27-rocketmq%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-producer/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-07-23T15:10:37+08:00"><meta property="article:modified_time" content="2021-07-23T15:10:37+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="RocketMQæºç é˜…è¯» Producer"><meta name=twitter:description content="RocketMQå¼€ç®±æºç è¯¦è§£-Producer-æˆ‘å°±æ˜¯ä¸ªæ‰“å·¥äºº"><link rel=stylesheet href=https://pinkhello.cc/css/styles.94f653e9e151e28067a7c5dbbc4600cbd5a3c721e79faaf971e523c40f3b249b8e4f20bb57810dfffa8d559ca5c140fd56eb4cd9c0853113ad08e66afdb08bdd.css integrity="sha512-lPZT6eFR4oBnp8XbvEYAy9WjxyHnn6r5ceUjxA87JJuOTyC7V4EN//qNVZylwUD9VutM2cCFMROtCOZq/bCL3Q=="><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script>
<script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel=icon type=image/png href=https://pinkhello.cc/images/favicon.ico><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","G-M2FXWC325L","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body class="max-width mx-auto px3 ltr"><div class="content index py4"><div id=header-post><a id=menu-icon href=#><i class="fas fa-bars fa-lg"></i></a>
<a id=menu-icon-tablet href=#><i class="fas fa-bars fa-lg"></i></a>
<a id=top-icon-tablet href=# onclick='$("html, body").animate({scrollTop:0},"fast")' style=display:none aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg"></i></a>
<span id=menu><span id=nav><ul><li><a href=/>Home</a></li><li><a href=/posts>Posts</a></li><li><a href=/categories>Category</a></li><li><a href=/tags>Tag</a></li><li><a href=/index.xml>Rss</a></li><li><a href=/jobs>Job</a></li></ul></span><br><span id=actions><ul><li><a class=icon href=https://pinkhello.cc/posts/26-rocketmq%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-nameserver/ aria-label=Previous><i class="fas fa-chevron-left" aria-hidden=true onmouseover='$("#i-prev").toggle()' onmouseout='$("#i-prev").toggle()'></i></a></li><li><a class=icon href=https://pinkhello.cc/posts/28-rocketmq%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-consumer/ aria-label=Next><i class="fas fa-chevron-right" aria-hidden=true onmouseover='$("#i-next").toggle()' onmouseout='$("#i-next").toggle()'></i></a></li><li><a class=icon href=# onclick='$("html, body").animate({scrollTop:0},"fast")' aria-label="Top of Page"><i class="fas fa-chevron-up" aria-hidden=true onmouseover='$("#i-top").toggle()' onmouseout='$("#i-top").toggle()'></i></a></li><li><a class=icon href=# aria-label=Share><i class="fas fa-share-alt" aria-hidden=true onmouseover='$("#i-share").toggle()' onmouseout='$("#i-share").toggle()' onclick='return $("#share").toggle(),!1'></i></a></li></ul><span id=i-prev class=info style=display:none>Previous post</span>
<span id=i-next class=info style=display:none>Next post</span>
<span id=i-top class=info style=display:none>Back to top</span>
<span id=i-share class=info style=display:none>Share post</span></span><br><div id=share style=display:none><ul><li><a class=icon href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fpinkhello.cc%2fposts%2f27-rocketmq%25E6%25BA%2590%25E7%25A0%2581%25E9%2598%2585%25E8%25AF%25BB-producer%2f" aria-label=Facebook><i class="fab fa-facebook" aria-hidden=true></i></a></li><li><a class=icon href="https://twitter.com/share?url=https%3a%2f%2fpinkhello.cc%2fposts%2f27-rocketmq%25E6%25BA%2590%25E7%25A0%2581%25E9%2598%2585%25E8%25AF%25BB-producer%2f&text=RocketMQ%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb%20Producer" aria-label=Twitter><i class="fab fa-twitter" aria-hidden=true></i></a></li><li><a class=icon href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fpinkhello.cc%2fposts%2f27-rocketmq%25E6%25BA%2590%25E7%25A0%2581%25E9%2598%2585%25E8%25AF%25BB-producer%2f&title=RocketMQ%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb%20Producer" aria-label=Linkedin><i class="fab fa-linkedin" aria-hidden=true></i></a></li><li><a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fpinkhello.cc%2fposts%2f27-rocketmq%25E6%25BA%2590%25E7%25A0%2581%25E9%2598%2585%25E8%25AF%25BB-producer%2f&is_video=false&description=RocketMQ%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb%20Producer" aria-label=Pinterest><i class="fab fa-pinterest" aria-hidden=true></i></a></li><li><a class=icon href="mailto:?subject=RocketMQ%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb%20Producer&body=Check out this article: https%3a%2f%2fpinkhello.cc%2fposts%2f27-rocketmq%25E6%25BA%2590%25E7%25A0%2581%25E9%2598%2585%25E8%25AF%25BB-producer%2f" aria-label=Email><i class="fas fa-envelope" aria-hidden=true></i></a></li><li><a class=icon href="https://getpocket.com/save?url=https%3a%2f%2fpinkhello.cc%2fposts%2f27-rocketmq%25E6%25BA%2590%25E7%25A0%2581%25E9%2598%2585%25E8%25AF%25BB-producer%2f&title=RocketMQ%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb%20Producer" aria-label=Pocket><i class="fab fa-get-pocket" aria-hidden=true></i></a></li><li><a class=icon href="http://reddit.com/submit?url=https%3a%2f%2fpinkhello.cc%2fposts%2f27-rocketmq%25E6%25BA%2590%25E7%25A0%2581%25E9%2598%2585%25E8%25AF%25BB-producer%2f&title=RocketMQ%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb%20Producer" aria-label=reddit><i class="fab fa-reddit" aria-hidden=true></i></a></li><li><a class=icon href="http://www.tumblr.com/share/link?url=https%3a%2f%2fpinkhello.cc%2fposts%2f27-rocketmq%25E6%25BA%2590%25E7%25A0%2581%25E9%2598%2585%25E8%25AF%25BB-producer%2f&name=RocketMQ%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb%20Producer&description=RocketMQ%e5%bc%80%e7%ae%b1%e6%ba%90%e7%a0%81%e8%af%a6%e8%a7%a3-Producer-%e6%88%91%e5%b0%b1%e6%98%af%e4%b8%aa%e6%89%93%e5%b7%a5%e4%ba%ba" aria-label=Tumblr><i class="fab fa-tumblr" aria-hidden=true></i></a></li><li><a class=icon href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fpinkhello.cc%2fposts%2f27-rocketmq%25E6%25BA%2590%25E7%25A0%2581%25E9%2598%2585%25E8%25AF%25BB-producer%2f&t=RocketMQ%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb%20Producer" aria-label="Hacker News"><i class="fab fa-hacker-news" aria-hidden=true></i></a></li></ul></div></span></div><article class=post itemscope itemtype=http://schema.org/BlogPosting><header><h1 class=posttitle itemprop="name headline">RocketMQæºç é˜…è¯» Producer</h1><div class=meta><div class=postdate><time datetime="2021-07-23 15:10:37 +0800 +0800" itemprop=datePublished>2021-07-23</time></div><div class=article-category><i class="fas fa-archive"></i>
<a class=category-link href=/categories/tech>Tech</a></div><div class=article-tag><i class="fas fa-tag"></i>
<a class=tag-link href=/tags/rocketmq rel=tag>RocketMQ</a></div></div></header><div id=toc><nav id=TableOfContents><ul><li><a href=#ç¬¬ä¸€æ­¥>ç¬¬ä¸€æ­¥</a></li><li><a href=#ç¬¬äºŒæ­¥-thisdefaultmqproducerimplstart>ç¬¬äºŒæ­¥ <code>this.defaultMQProducerImpl.start()</code>;</a></li><li><a href=#ç¬¬ä¸‰æ­¥-mqclientinstance-æ ¸å¿ƒå¯åŠ¨æ–¹æ³•-mqclientfactorystart>ç¬¬ä¸‰æ­¥ MQClientInstance æ ¸å¿ƒå¯åŠ¨æ–¹æ³• <code>mQClientFactory.start()</code>;</a></li></ul><ul><li><ul><li><a href=#defaultmqproducersend>DefaultMQProducer.send</a></li><li><a href=#defaultmqproducerimplsenddefaultimpl>DefaultMQProducerImpl.sendDefaultImpl</a></li><li><a href=#defaultmqproducerimplsendkernelimpl-è¿™ä¸ªæ–¹æ³•æ˜¯æ ¸å¿ƒå‘é€æ–¹æ³•>DefaultMQProducerImpl.sendKernelImpl è¿™ä¸ªæ–¹æ³•æ˜¯æ ¸å¿ƒå‘é€æ–¹æ³•</a></li><li><a href=#mqclientapiimplsendmessage--å’Œ-mqclientapiimplsendmessagesync>MQClientAPIImpl.sendMessage å’Œ MQClientAPIImpl.sendMessageSync</a></li></ul></li></ul></nav></div><div class=content itemprop=articleBody><p>åœ¨æ¶ˆæ¯å‘é€çš„æ—¶å€™, æˆ‘ä»¬å…ˆçœ‹ <code>Producer</code> çš„å¯åŠ¨ä»£ç </p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Producer</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span><span style=color:#f92672>(</span>String<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> MQClientException<span style=color:#f92672>,</span> InterruptedException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        DefaultMQProducer producer <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> DefaultMQProducer<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;ProducerGroupName&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        producer<span style=color:#f92672>.</span><span style=color:#a6e22e>start</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> i <span style=color:#f92672>&lt;</span> 128<span style=color:#f92672>;</span> i<span style=color:#f92672>++){</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                Message msg <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Message<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;TopicTest&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;TagA&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;OrderID188&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Hello world&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getBytes</span><span style=color:#f92672>(</span>RemotingHelper<span style=color:#f92672>.</span><span style=color:#a6e22e>DEFAULT_CHARSET</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>                SendResult sendResult <span style=color:#f92672>=</span> producer<span style=color:#f92672>.</span><span style=color:#a6e22e>send</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>printf</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;%s%n&#34;</span><span style=color:#f92672>,</span> sendResult<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Exception e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                e<span style=color:#f92672>.</span><span style=color:#a6e22e>printStackTrace</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>  
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        producer<span style=color:#f92672>.</span><span style=color:#a6e22e>shutdown</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>éå¸¸ç®€å•çš„ä»£ç æ„å»ºäº†ä¸€ä¸ª <code>Producer</code>
ä¸‹é¢è‚¯å®šæœ‰ç–‘é—®:</p><ul><li><code>Producer</code> å¦‚ä½•å¯åŠ¨çš„</li><li><code>Producer</code> å‘é€æ¶ˆæ¯æµç¨‹</li><li><code>Producer</code> å’Œ <code>NameSever</code> å¦‚ä½•äº¤äº’</li><li><code>Producer</code> å‘é€æ¶ˆæ¯å¦‚ä½•ä¿è¯é¡ºåº</li><li><code>Producer</code> è´Ÿè½½å‡è¡¡å¦‚ä½•å®ç°çš„</li><li><code>Producer</code> å»¶è¿Ÿæ¶ˆæ¯ï¼ˆå‘é€çš„æ—¶å€™è®¾ç½® <code>Message</code> çš„å»¶è¿Ÿçº§åˆ«ï¼‰</li></ul><h1 id=producer-ç«¯-å¦‚ä½•å¯åŠ¨çš„>Producer ç«¯ å¦‚ä½•å¯åŠ¨çš„</h1><h2 id=ç¬¬ä¸€æ­¥>ç¬¬ä¸€æ­¥</h2><p>å¯ä»¥çœ‹åˆ°å¯åŠ¨ä¸€ä¸ª <code>Producer</code> çš„ä»£ç , æ ¸å¿ƒç±» <code>DefaultMQProducer</code> ,æ„é€ æ–¹æ³•ä¸­åˆ New äº†ä¸€ä¸ªæ–°çš„ç±» <code>DefaultMQProducerImpl</code>, è¿™ä¸ªç±»æ˜¯ç»™çœŸæ­£çš„æ ¸å¿ƒçš„ç±»</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>DefaultMQProducer</span><span style=color:#f92672>(</span><span style=color:#66d9ef>final</span> String namespace<span style=color:#f92672>,</span> <span style=color:#66d9ef>final</span> String producerGroup<span style=color:#f92672>,</span> RPCHook rpcHook<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>namespace</span> <span style=color:#f92672>=</span> namespace<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>producerGroup</span> <span style=color:#f92672>=</span> producerGroup<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        defaultMQProducerImpl <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> DefaultMQProducerImpl<span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>,</span> rpcHook<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>åé¢å…¥å£èµ°åˆ° <code>start</code> æ–¹æ³•, å†…éƒ¨å¯åŠ¨çš„ <code>defaultMQProducerImpl.start</code> æ–¹æ³•</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>start</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> MQClientException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//å¯åŠ¨ Producer
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>setProducerGroup</span><span style=color:#f92672>(</span>withNamespace<span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>producerGroup</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//çœŸå®çš„å¯åŠ¨
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>defaultMQProducerImpl</span><span style=color:#f92672>.</span><span style=color:#a6e22e>start</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//.... ä¸‹é¢ä»£ç  çœç•¥ åªçœ‹æ ¸å¿ƒä»£ç 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=ç¬¬äºŒæ­¥-thisdefaultmqproducerimplstart>ç¬¬äºŒæ­¥ <code>this.defaultMQProducerImpl.start()</code>;</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>start</span><span style=color:#f92672>(</span><span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> startFactory<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> MQClientException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>switch</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>serviceState</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>//ç¬¬ä¸€æ¬¡ é»˜è®¤ new Producer æ˜¯ CreateJust çŠ¶æ€
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>case</span> CREATE_JUST<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// å®Œå…¨å¯åŠ¨å ç½®æˆ ServiceState.RUNNING
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>serviceState</span> <span style=color:#f92672>=</span> ServiceState<span style=color:#f92672>.</span><span style=color:#a6e22e>START_FAILED</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>//æ£€æŸ¥é…ç½®     group æ˜¯å¦å¡«å†™ã€æ˜¯ä¸æ˜¯é»˜è®¤çš„åå­—ã€é•¿åº¦æ˜¯ä¸æ˜¯è¶…å‡ºé™åˆ¶......
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>checkConfig</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>//æ›´æ”¹ instanceName ä¸º PID
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>defaultMQProducer</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getProducerGroup</span><span style=color:#f92672>().</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>MixAll<span style=color:#f92672>.</span><span style=color:#a6e22e>CLIENT_INNER_PRODUCER_GROUP</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>defaultMQProducer</span><span style=color:#f92672>.</span><span style=color:#a6e22e>changeInstanceNameToPID</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>                 *   å•ä¾‹æ¨¡å¼, è·å– MQClientInstance å¯¹è±¡, å®¢æˆ·ç«¯å®ä¾‹
</span></span></span><span style=display:flex><span><span style=color:#75715e>                 *   MQClientManager JVMåªæœ‰ä¸€ä¸ª é™æ€å¸¸é‡
</span></span></span><span style=display:flex><span><span style=color:#75715e>                 *   MQClientManager å†…éƒ¨ç»´æŠ¤ç€ clientId - MQClientInstance çš„ç¼“å­˜ factoryTable
</span></span></span><span style=display:flex><span><span style=color:#75715e>                 */</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>mQClientFactory</span> <span style=color:#f92672>=</span> MQClientManager<span style=color:#f92672>.</span><span style=color:#a6e22e>getInstance</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getOrCreateMQClientInstance</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>defaultMQProducer</span><span style=color:#f92672>,</span> rpcHook<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>//å°† Producer æ³¨å†Œåˆ° Producer Group ä¸­, æ³¨å†Œçš„ ä½¿ç”¨ producerTable ç»´æŠ¤
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>///**
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>// *  private final ConcurrentMap&lt;String,MQProducerInner &gt; producerTable
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>// *  = new ConcurrentHashMap&lt;String, MQProducerInner&gt;();
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>// */
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>boolean</span> registerOK <span style=color:#f92672>=</span> mQClientFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>registerProducer</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>defaultMQProducer</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getProducerGroup</span><span style=color:#f92672>(),</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>registerOK<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>serviceState</span> <span style=color:#f92672>=</span> ServiceState<span style=color:#f92672>.</span><span style=color:#a6e22e>CREATE_JUST</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> MQClientException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;The producer group[&#34;</span> <span style=color:#f92672>+</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>defaultMQProducer</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getProducerGroup</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;] has been created before, specify another name please.&#34;</span> <span style=color:#f92672>+</span> FAQUrl<span style=color:#f92672>.</span><span style=color:#a6e22e>suggestTodo</span><span style=color:#f92672>(</span>FAQUrl<span style=color:#f92672>.</span><span style=color:#a6e22e>GROUP_NAME_DUPLICATE_URL</span><span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// å­˜å‚¨è·¯ç”±ä¿¡æ¯çš„å¯¹è±¡  TopicPublishInfo æ˜¯è·¯ç”±ä¿¡æ¯
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>// this.defaultMQProducer.getCreateTopicKey() è·å– message ä¸­çš„ topic, ä½†æ˜¯åœ¨æ­¤ï¼Œè¿˜æ²¡é‚£æ · message è¿›å…¥ã€‚çœ‹å…·ä½“çš„
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>// æ˜¯ä¸ªé»˜è®¤çš„Key, å¯åŠ¨çš„æ—¶å€™ä¸ºäº†æµ‹è¯•å’Œdemoè¿è¡Œ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>//     /**
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>//     * Just for testing or demo program
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>//     */
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>//    private String createTopicKey = TopicValidator.AUTO_CREATE_TOPIC_KEY_TOPIC;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>topicPublishInfoTable</span><span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>defaultMQProducer</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getCreateTopicKey</span><span style=color:#f92672>(),</span> <span style=color:#66d9ef>new</span> TopicPublishInfo<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>//å¯åŠ¨ç”Ÿäº§
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>startFactory<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>//MQClientInstance çš„ start   çœŸæ­£çš„å¯åŠ¨æ ¸å¿ƒç±»
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    mQClientFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>start</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                log<span style=color:#f92672>.</span><span style=color:#a6e22e>info</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;the producer [{}] start OK. sendMessageWithVIPChannel={}&#34;</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>defaultMQProducer</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getProducerGroup</span><span style=color:#f92672>(),</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>defaultMQProducer</span><span style=color:#f92672>.</span><span style=color:#a6e22e>isSendMessageWithVIPChannel</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>serviceState</span> <span style=color:#f92672>=</span> ServiceState<span style=color:#f92672>.</span><span style=color:#a6e22e>RUNNING</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> RUNNING<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> START_FAILED<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> SHUTDOWN_ALREADY<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> MQClientException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;The producer service state not OK, maybe started once, &#34;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>+</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>serviceState</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>+</span> FAQUrl<span style=color:#f92672>.</span><span style=color:#a6e22e>suggestTodo</span><span style=color:#f92672>(</span>FAQUrl<span style=color:#f92672>.</span><span style=color:#a6e22e>CLIENT_SERVICE_NOT_OK</span><span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//å¯åŠ¨å‘æ‰€æœ‰çš„ broker å‘é€å¿ƒæ€
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>mQClientFactory</span><span style=color:#f92672>.</span><span style=color:#a6e22e>sendHeartbeatToAllBrokerWithLock</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// æ¯éš” 3 ç§’ æ‰«æè¿‡æœŸçš„è¯·æ±‚
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>timer</span><span style=color:#f92672>.</span><span style=color:#a6e22e>scheduleAtFixedRate</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> TimerTask<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    RequestFutureTable<span style=color:#f92672>.</span><span style=color:#a6e22e>scanExpiredRequest</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Throwable e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    log<span style=color:#f92672>.</span><span style=color:#a6e22e>error</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;scan RequestFutureTable exception&#34;</span><span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>},</span> 1000 <span style=color:#f92672>*</span> 3<span style=color:#f92672>,</span> 1000<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>ä¸Šè¿°ä»£ç çœ‹æ³¨é‡Š</p><ul><li><ol><li><code>serviceState</code> åœ¨ <code>new producer</code> é»˜è®¤ä¸º <code>CreateJust</code> çŠ¶æ€, å…ˆè®¾ç½®ä¸º <code>START_FAILE</code></li></ol></li><li><ol start=2><li><code>checkConfig</code> æ£€æŸ¥é…ç½®, çœ‹ <code>group</code> æ˜¯å¦å¡«å†™, æ˜¯ä¸æ˜¯é»˜è®¤çš„åç§°, é•¿åº¦æ˜¯å¦è¶…è¿‡é™åˆ¶</li></ol></li><li><ol start=3><li>æ›´æ”¹ <code>InstanceName</code> ä¸º PID</li></ol></li><li><ol start=4><li>æ„å»º <code>MQClientManager</code>ï¼ˆå•ä¾‹æ¨¡å¼ï¼‰æä¾›è·å– <code>MQClientInstance</code> å®ä¾‹, å†…éƒ¨ç»´æŠ¤è€…ä¸€ä¸ª <code>ClientId</code> å’Œ <code>MQClientInstance</code> çš„ç¼“å­˜</li></ol></li><li><ol start=5><li>æ³¨å†Œ <code>Producer</code> åˆ° <code>ProducerGroup</code> ä¸­ (çº¿ç¨‹å®‰å…¨çš„Map)</li></ol></li><li><ol start=6><li>å­˜å‚¨è·¯ç”±ä¿¡æ¯çš„å¯¹è±¡(<code>TopicPublishInfo</code>) è¿™è¾¹åªæ˜¯ä¸ºäº†æµ‹è¯•å’Œdemoç¨‹åº</li></ol></li><li><ol start=7><li>åé¢å¯åŠ¨çœŸå®çš„ <code>mQClientFactory.start()</code></li></ol></li><li><ol start=8><li>æ›´æ”¹ <code>serviceState</code> æˆ <code>RUNNING</code></li></ol></li><li><ol start=9><li>å‘æ‰€æœ‰çš„ <code>Broker</code> å‘é€å¿ƒè·³</li></ol></li><li>10.æ¯éš” <code>3</code> ç§’ æ‰«æè¿‡æœŸçš„è¯·æ±‚</li></ul><h2 id=ç¬¬ä¸‰æ­¥-mqclientinstance-æ ¸å¿ƒå¯åŠ¨æ–¹æ³•-mqclientfactorystart>ç¬¬ä¸‰æ­¥ MQClientInstance æ ¸å¿ƒå¯åŠ¨æ–¹æ³• <code>mQClientFactory.start()</code>;</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>start</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> MQClientException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>synchronized</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>switch</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>serviceState</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>case</span> CREATE_JUST<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>serviceState</span> <span style=color:#f92672>=</span> ServiceState<span style=color:#f92672>.</span><span style=color:#a6e22e>START_FAILED</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// If not specified,looking address from name server
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#75715e>// ä» é…ç½®ä¸­æ‰¾å¯» NameServer åœ°å€
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>null</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>clientConfig</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getNamesrvAddr</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>mQClientAPIImpl</span><span style=color:#f92672>.</span><span style=color:#a6e22e>fetchNameServerAddr</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// Start request-response channel
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#75715e>// å¼€å¯ request-response é€šé“(ä»£ç ä¸Šå¤ç”¨çš„é€šä¿¡ç»„ä»¶ Netty é“¾æ¥)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>mQClientAPIImpl</span><span style=color:#f92672>.</span><span style=color:#a6e22e>start</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// Start various schedule tasks  | å¼€å¯ å¾ˆå¤šçš„å®šæ—¶ä»»åŠ¡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>                     * å®šæ—¶ä»»åŠ¡æœ‰:
</span></span></span><span style=display:flex><span><span style=color:#75715e>                     * 1. æ¯éš” 2 åˆ†é’Ÿæ£€æµ‹ NameServer çš„å˜åŒ–
</span></span></span><span style=display:flex><span><span style=color:#75715e>                     * 2. æ¯éš” 30 ç§’ä» NameServer è·å– Topic è·¯ç”±ä¿¡æ¯å˜åŒ– å’Œ æ–°çš„ Topic è·¯ç”±ä¿¡æ¯
</span></span></span><span style=display:flex><span><span style=color:#75715e>                     * 3. æ¯éš” 30 ç§’æ¸…ç† ä¸‹çº¿çš„ Broker
</span></span></span><span style=display:flex><span><span style=color:#75715e>                     * 4. æ¯éš” 5 ç§’ æŒä¹…åŒ–æ‰€æœ‰çš„æ¶ˆè´¹è¿›åº¦
</span></span></span><span style=display:flex><span><span style=color:#75715e>                     * 5. æ¯éš” 1 åˆ†é’Ÿ æ£€è½¦çº¿ç¨‹æ± å¤§å°æ˜¯å¦éœ€è¦è°ƒæ•´
</span></span></span><span style=display:flex><span><span style=color:#75715e>                     */</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>startScheduledTask</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// Start pull service
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#75715e>// å¯åŠ¨æ‹‰å–æ¶ˆæ¯çš„æœåŠ¡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>pullMessageService</span><span style=color:#f92672>.</span><span style=color:#a6e22e>start</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// Start rebalance service
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#75715e>// å¯åŠ¨ Rebalance è´Ÿè½½å‡è¡¡æœåŠ¡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>rebalanceService</span><span style=color:#f92672>.</span><span style=color:#a6e22e>start</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// Start push service
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>                     * è¿™é‡Œåˆè°ƒç”¨äº† DefaultMQProducerImpl çš„ start æ–¹æ³•, å› ä¸ºä¼ å…¥çš„ false, ä¸ä¼šè¿›å…¥å¾ªç¯å¯åŠ¨
</span></span></span><span style=display:flex><span><span style=color:#75715e>                     * æœªæŠ¥é”™çš„è¯æ˜¯ä¸ºäº†å…ˆå°† DefaultMQProducerImpl å®ä¾‹å†…çš„çŠ¶æ€æœºçŠ¶æ€ å…ˆå˜æ›´ä¸º ServiceState.RUNNING
</span></span></span><span style=display:flex><span><span style=color:#75715e>                     */</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>defaultMQProducer</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getDefaultMQProducerImpl</span><span style=color:#f92672>().</span><span style=color:#a6e22e>start</span><span style=color:#f92672>(</span><span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    log<span style=color:#f92672>.</span><span style=color:#a6e22e>info</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;the client factory [{}] start OK&#34;</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>clientId</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>//å¯åŠ¨å®Œæ¯•, å˜æ›´çŠ¶æ€
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>serviceState</span> <span style=color:#f92672>=</span> ServiceState<span style=color:#f92672>.</span><span style=color:#a6e22e>RUNNING</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>case</span> START_FAILED<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> MQClientException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;The Factory object[&#34;</span> <span style=color:#f92672>+</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getClientId</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;] has been created before, and failed.&#34;</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>è¿™è¾¹çš„ä»£ç ä¸»è¦æ˜¯å¼€å¯å¤šä¸ªæœåŠ¡äº†</p><ul><li><ol><li>ä» é…ç½®ä¸­æ‰¾å¯» <code>NameServer</code> åœ°å€</li></ol></li><li><ol start=2><li>å¼€å¯ <code>request response</code> é€šé“</li></ol></li><li><ol start=3><li>å¼€å¯å¾ˆå¤šçš„å®šæ—¶ä»»åŠ¡</li></ol><ul><li>æ¯éš” 2 åˆ†é’Ÿæ£€æµ‹ <code>NameServer</code> çš„å˜åŒ–</li><li>æ¯éš” 30 ç§’ä» <code>NameServer</code> è·å– <code>Topic</code> è·¯ç”±ä¿¡æ¯å˜åŒ– å’Œ æ–°çš„ <code>Topic</code> è·¯ç”±ä¿¡æ¯</li><li>æ¯éš” 30 ç§’æ¸…ç† ä¸‹çº¿çš„ Broker</li><li>æ¯éš” 5 ç§’ æŒä¹…åŒ–æ‰€æœ‰çš„æ¶ˆè´¹è¿›åº¦</li><li>æ¯éš” 1 åˆ†é’Ÿ æ£€æŸ¥çº¿ç¨‹æ± å¤§å°æ˜¯å¦éœ€è¦è°ƒæ•´</li></ul></li><li><ol start=4><li>å¯åŠ¨æ‹‰å–æ¶ˆæ¯çš„æœåŠ¡</li></ol></li><li><ol start=5><li>å¯åŠ¨ <code>Rebalance</code> è´Ÿè½½å‡è¡¡æœåŠ¡</li></ol></li><li><ol start=6><li><code>Start push service</code> è°ƒç”¨äº† <code>DefaultMQProducerImpl.start</code></li></ol></li><li><ol start=7><li>å¯åŠ¨å®Œæ¯•, å˜æ›´çŠ¶æ€</li></ol></li></ul><h1 id=producer-å‘é€æ¶ˆæ¯æµç¨‹>Producer å‘é€æ¶ˆæ¯æµç¨‹</h1><p>å‘é€é€»è¾‘è·¯å¾„
<code>DefaultMQProducer.send</code>
->
<code>DefaultMQProducerImpl.send</code>
->
<code>DefaultMQProducerImpl.sendDefaultImpl</code>
->
<code>DefaultMQProducerImpl.sendKernelImpl</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span> <span style=color:#75715e>// å…¥å£
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> SendResult sendResult <span style=color:#f92672>=</span> producer<span style=color:#f92672>.</span><span style=color:#a6e22e>send</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>);</span>
</span></span></code></pre></div><h3 id=defaultmqproducersend>DefaultMQProducer.send</h3><pre tabindex=0><code>        //  æ£€æŸ¥ msg çš„ topic åŸºç¡€ä¿¡æ¯( topic åç§°ä¸ä¸ºç©º, topic åç§°ä¸åŒ…å«éæ³•å­—ç¬¦, topic åç§°é•¿åº¦&lt;127)
        @Override
        public SendResult send(
                Message msg) throws MQClientException, RemotingException, MQBrokerException, InterruptedException {
                //å‚æ•°æ ¡éªŒ
                Validators.checkMessage(msg, this);
                //è®¾ç½® topic
                msg.setTopic(withNamespace(msg.getTopic()));
                //å‘é€æ¶ˆæ¯
                return this.defaultMQProducerImpl.send(msg);
        }
</code></pre><h3 id=defaultmqproducerimplsenddefaultimpl>DefaultMQProducerImpl.sendDefaultImpl</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> SendResult <span style=color:#a6e22e>sendDefaultImpl</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>        Message msg<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> CommunicationMode communicationMode<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> SendCallback sendCallback<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>long</span> timeout
</span></span><span style=display:flex><span>    <span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> MQClientException<span style=color:#f92672>,</span> RemotingException<span style=color:#f92672>,</span> MQBrokerException<span style=color:#f92672>,</span> InterruptedException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//æ£€æŸ¥ Producer çŠ¶æ€OK
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>makeSureStateOK</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//æ£€æŸ¥ message ä¿¡æ¯
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        Validators<span style=color:#f92672>.</span><span style=color:#a6e22e>checkMessage</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>,</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>defaultMQProducer</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>long</span> invokeID <span style=color:#f92672>=</span> random<span style=color:#f92672>.</span><span style=color:#a6e22e>nextLong</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//è®°å½• å¼€å§‹æ—¶é—´
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>long</span> beginTimestampFirst <span style=color:#f92672>=</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>currentTimeMillis</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//ä¸Šæ­¤çš„å¼€å§‹æ—¶é—´é»˜è®¤ä¸ºå¼€å§‹æ—¶é—´
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>long</span> beginTimestampPrev <span style=color:#f92672>=</span> beginTimestampFirst<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//ç»“æŸæ—¶é—´é»˜è®¤ä¸ºå¼€å§‹æ—¶é—´
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>long</span> endTimestamp <span style=color:#f92672>=</span> beginTimestampFirst<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//è·å– Topic å¯¹åº”çš„è·¯ç”±ä¿¡æ¯
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        TopicPublishInfo topicPublishInfo <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>tryToFindTopicPublishInfo</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>.</span><span style=color:#a6e22e>getTopic</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>topicPublishInfo <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> topicPublishInfo<span style=color:#f92672>.</span><span style=color:#a6e22e>ok</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>boolean</span> callTimeout <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            MessageQueue mq <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            Exception exception <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            SendResult sendResult <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>//æ ¹æ®æ¨¡å¼, åŒæ­¥ è¿˜æ˜¯ å¼‚æ­¥, å†³å®šå‘é€å¤±è´¥çš„é‡è¯•çš„æ€»æ¬¡æ•°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>int</span> timesTotal <span style=color:#f92672>=</span> communicationMode <span style=color:#f92672>==</span> CommunicationMode<span style=color:#f92672>.</span><span style=color:#a6e22e>SYNC</span> <span style=color:#f92672>?</span> 1 <span style=color:#f92672>+</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>defaultMQProducer</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getRetryTimesWhenSendFailed</span><span style=color:#f92672>()</span> <span style=color:#f92672>:</span> 1<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>int</span> times <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            String<span style=color:#f92672>[]</span> brokersSent <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> String<span style=color:#f92672>[</span>timesTotal<span style=color:#f92672>];</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>//å¾ªç¯å‘é€, æˆåŠŸå‘é€çš„è·³å‡ºå¾ªç¯
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>for</span> <span style=color:#f92672>(;</span> times <span style=color:#f92672>&lt;</span> timesTotal<span style=color:#f92672>;</span> times<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                String lastBrokerName <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>==</span> mq <span style=color:#f92672>?</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>:</span> mq<span style=color:#f92672>.</span><span style=color:#a6e22e>getBrokerName</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>//é€‰æ‹©åˆé€‚çš„é˜Ÿåˆ—  æ ¸å¿ƒçš„æ–¹æ³•( å¼€å¯ å®¹é”™ç­–ç•¥çš„è¯çš„æ ¸å¿ƒæ–¹æ³•)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                MessageQueue mqSelected <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>selectOneMessageQueue</span><span style=color:#f92672>(</span>topicPublishInfo<span style=color:#f92672>,</span> lastBrokerName<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>//é˜Ÿåˆ—ä¸ä¸ºç©ºè¿›è¡Œå‘é€
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>mqSelected <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    mq <span style=color:#f92672>=</span> mqSelected<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                    brokersSent<span style=color:#f92672>[</span>times<span style=color:#f92672>]</span> <span style=color:#f92672>=</span> mq<span style=color:#f92672>.</span><span style=color:#a6e22e>getBrokerName</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#75715e>//è®°å½•ä¸Šæ¬¡çš„å¼€å§‹æ—¶é—´
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        beginTimestampPrev <span style=color:#f92672>=</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>currentTimeMillis</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>times <span style=color:#f92672>&gt;</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                            <span style=color:#75715e>//Reset topic with namespace during resend.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                            msg<span style=color:#f92672>.</span><span style=color:#a6e22e>setTopic</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>defaultMQProducer</span><span style=color:#f92672>.</span><span style=color:#a6e22e>withNamespace</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>.</span><span style=color:#a6e22e>getTopic</span><span style=color:#f92672>()));</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                        <span style=color:#75715e>//å‘é€å·²ç»è€—è´¹çš„æ€»æ—¶é—´, å¦‚æœåœ¨è§„å®šçš„æ—¶é—´å†…, è¿˜æ²¡æœ‰å‘é€æˆåŠŸ, è·³å‡ºé‡è¯•
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        <span style=color:#66d9ef>long</span> costTime <span style=color:#f92672>=</span> beginTimestampPrev <span style=color:#f92672>-</span> beginTimestampFirst<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>timeout <span style=color:#f92672>&lt;</span> costTime<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                            callTimeout <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                        <span style=color:#75715e>//å‘é€
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        sendResult <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>sendKernelImpl</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>,</span> mq<span style=color:#f92672>,</span> communicationMode<span style=color:#f92672>,</span> sendCallback<span style=color:#f92672>,</span> topicPublishInfo<span style=color:#f92672>,</span> timeout <span style=color:#f92672>-</span> costTime<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                        endTimestamp <span style=color:#f92672>=</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>currentTimeMillis</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                        <span style=color:#75715e>//æ ¹æ®å‘é€è€—è´¹çš„æ—¶é—´å†³å®šæ˜¯ä¸æ˜¯è¦å°†è¯¥ Broker åŠ å…¥åˆ°æ•…éšœåˆ—è¡¨ç¼“å­˜ä¸­
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>updateFaultItem</span><span style=color:#f92672>(</span>mq<span style=color:#f92672>.</span><span style=color:#a6e22e>getBrokerName</span><span style=color:#f92672>(),</span> endTimestamp <span style=color:#f92672>-</span> beginTimestampPrev<span style=color:#f92672>,</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                        <span style=color:#75715e>//æ ¹æ®æ¨¡å¼å†³å®šåšä»€ä¹ˆåŠ¨ä½œ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        <span style=color:#66d9ef>switch</span> <span style=color:#f92672>(</span>communicationMode<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>case</span> ASYNC<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                                <span style=color:#75715e>//å¼‚æ­¥ ä»€ä¹ˆéƒ½ä¸åš
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>case</span> ONEWAY<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                                <span style=color:#75715e>//oneway ä»€ä¹ˆéƒ½ä¸åš
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>case</span> SYNC<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                                <span style=color:#75715e>//åŒæ­¥å‘é€ æ ¹æ®å‘é€è¿”å›çŠ¶æ€å†³å®šæ˜¯å¦é‡è¯•
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>sendResult<span style=color:#f92672>.</span><span style=color:#a6e22e>getSendStatus</span><span style=color:#f92672>()</span> <span style=color:#f92672>!=</span> SendStatus<span style=color:#f92672>.</span><span style=color:#a6e22e>SEND_OK</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                                    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>defaultMQProducer</span><span style=color:#f92672>.</span><span style=color:#a6e22e>isRetryAnotherBrokerWhenNotStoreOK</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                                        <span style=color:#66d9ef>continue</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                                    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                                <span style=color:#75715e>//å‘é€æˆåŠŸç›´æ¥ç»“æŸæ–¹æ³•
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                                <span style=color:#66d9ef>return</span> sendResult<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                                <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>RemotingException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#75715e>//å‡ºç°å¼‚å¸¸åŠ å…¥æ•…éšœåˆ—è¡¨, è¿›è¡Œé‡è¯•
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        endTimestamp <span style=color:#f92672>=</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>currentTimeMillis</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>updateFaultItem</span><span style=color:#f92672>(</span>mq<span style=color:#f92672>.</span><span style=color:#a6e22e>getBrokerName</span><span style=color:#f92672>(),</span> endTimestamp <span style=color:#f92672>-</span> beginTimestampPrev<span style=color:#f92672>,</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                        log<span style=color:#f92672>.</span><span style=color:#a6e22e>warn</span><span style=color:#f92672>(</span>String<span style=color:#f92672>.</span><span style=color:#a6e22e>format</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;sendKernelImpl exception, resend at once, InvokeID: %s, RT: %sms, Broker: %s&#34;</span><span style=color:#f92672>,</span> invokeID<span style=color:#f92672>,</span> endTimestamp <span style=color:#f92672>-</span> beginTimestampPrev<span style=color:#f92672>,</span> mq<span style=color:#f92672>),</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                        log<span style=color:#f92672>.</span><span style=color:#a6e22e>warn</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>                        exception <span style=color:#f92672>=</span> e<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>continue</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>MQClientException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#75715e>//å‡ºç°å¼‚å¸¸åŠ å…¥æ•…éšœåˆ—è¡¨, è¿›è¡Œé‡è¯•
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        endTimestamp <span style=color:#f92672>=</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>currentTimeMillis</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>updateFaultItem</span><span style=color:#f92672>(</span>mq<span style=color:#f92672>.</span><span style=color:#a6e22e>getBrokerName</span><span style=color:#f92672>(),</span> endTimestamp <span style=color:#f92672>-</span> beginTimestampPrev<span style=color:#f92672>,</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                        log<span style=color:#f92672>.</span><span style=color:#a6e22e>warn</span><span style=color:#f92672>(</span>String<span style=color:#f92672>.</span><span style=color:#a6e22e>format</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;sendKernelImpl exception, resend at once, InvokeID: %s, RT: %sms, Broker: %s&#34;</span><span style=color:#f92672>,</span> invokeID<span style=color:#f92672>,</span> endTimestamp <span style=color:#f92672>-</span> beginTimestampPrev<span style=color:#f92672>,</span> mq<span style=color:#f92672>),</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                        log<span style=color:#f92672>.</span><span style=color:#a6e22e>warn</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>                        exception <span style=color:#f92672>=</span> e<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>continue</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>MQBrokerException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#75715e>//å‡ºç°å¼‚å¸¸åŠ å…¥æ•…éšœåˆ—è¡¨, è¿›è¡Œé‡è¯•
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        endTimestamp <span style=color:#f92672>=</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>currentTimeMillis</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>updateFaultItem</span><span style=color:#f92672>(</span>mq<span style=color:#f92672>.</span><span style=color:#a6e22e>getBrokerName</span><span style=color:#f92672>(),</span> endTimestamp <span style=color:#f92672>-</span> beginTimestampPrev<span style=color:#f92672>,</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                        log<span style=color:#f92672>.</span><span style=color:#a6e22e>warn</span><span style=color:#f92672>(</span>String<span style=color:#f92672>.</span><span style=color:#a6e22e>format</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;sendKernelImpl exception, resend at once, InvokeID: %s, RT: %sms, Broker: %s&#34;</span><span style=color:#f92672>,</span> invokeID<span style=color:#f92672>,</span> endTimestamp <span style=color:#f92672>-</span> beginTimestampPrev<span style=color:#f92672>,</span> mq<span style=color:#f92672>),</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                        log<span style=color:#f92672>.</span><span style=color:#a6e22e>warn</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>                        exception <span style=color:#f92672>=</span> e<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>switch</span> <span style=color:#f92672>(</span>e<span style=color:#f92672>.</span><span style=color:#a6e22e>getResponseCode</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>case</span> ResponseCode<span style=color:#f92672>.</span><span style=color:#a6e22e>TOPIC_NOT_EXIST</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>case</span> ResponseCode<span style=color:#f92672>.</span><span style=color:#a6e22e>SERVICE_NOT_AVAILABLE</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>case</span> ResponseCode<span style=color:#f92672>.</span><span style=color:#a6e22e>SYSTEM_ERROR</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>case</span> ResponseCode<span style=color:#f92672>.</span><span style=color:#a6e22e>NO_PERMISSION</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>case</span> ResponseCode<span style=color:#f92672>.</span><span style=color:#a6e22e>NO_BUYER_ID</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>case</span> ResponseCode<span style=color:#f92672>.</span><span style=color:#a6e22e>NOT_IN_CURRENT_UNIT</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                                <span style=color:#66d9ef>continue</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>sendResult <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                                    <span style=color:#66d9ef>return</span> sendResult<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                                <span style=color:#66d9ef>throw</span> e<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>InterruptedException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#75715e>//å‡ºç°å¼‚å¸¸åŠ å…¥æ•…éšœåˆ—è¡¨, è¿›è¡Œé‡è¯•
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        endTimestamp <span style=color:#f92672>=</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>currentTimeMillis</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>updateFaultItem</span><span style=color:#f92672>(</span>mq<span style=color:#f92672>.</span><span style=color:#a6e22e>getBrokerName</span><span style=color:#f92672>(),</span> endTimestamp <span style=color:#f92672>-</span> beginTimestampPrev<span style=color:#f92672>,</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                        log<span style=color:#f92672>.</span><span style=color:#a6e22e>warn</span><span style=color:#f92672>(</span>String<span style=color:#f92672>.</span><span style=color:#a6e22e>format</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;sendKernelImpl exception, throw exception, InvokeID: %s, RT: %sms, Broker: %s&#34;</span><span style=color:#f92672>,</span> invokeID<span style=color:#f92672>,</span> endTimestamp <span style=color:#f92672>-</span> beginTimestampPrev<span style=color:#f92672>,</span> mq<span style=color:#f92672>),</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                        log<span style=color:#f92672>.</span><span style=color:#a6e22e>warn</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                        log<span style=color:#f92672>.</span><span style=color:#a6e22e>warn</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;sendKernelImpl exception&#34;</span><span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                        log<span style=color:#f92672>.</span><span style=color:#a6e22e>warn</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>throw</span> e<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>sendResult <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> sendResult<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            String info <span style=color:#f92672>=</span> String<span style=color:#f92672>.</span><span style=color:#a6e22e>format</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Send [%d] times, still failed, cost [%d]ms, Topic: %s, BrokersSent: %s&#34;</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                times<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                System<span style=color:#f92672>.</span><span style=color:#a6e22e>currentTimeMillis</span><span style=color:#f92672>()</span> <span style=color:#f92672>-</span> beginTimestampFirst<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                msg<span style=color:#f92672>.</span><span style=color:#a6e22e>getTopic</span><span style=color:#f92672>(),</span>
</span></span><span style=display:flex><span>                Arrays<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>(</span>brokersSent<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            info <span style=color:#f92672>+=</span> FAQUrl<span style=color:#f92672>.</span><span style=color:#a6e22e>suggestTodo</span><span style=color:#f92672>(</span>FAQUrl<span style=color:#f92672>.</span><span style=color:#a6e22e>SEND_MSG_FAILED</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            MQClientException mqClientException <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> MQClientException<span style=color:#f92672>(</span>info<span style=color:#f92672>,</span> exception<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>callTimeout<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RemotingTooMuchRequestException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;sendDefaultImpl call timeout&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>exception <span style=color:#66d9ef>instanceof</span> MQBrokerException<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                mqClientException<span style=color:#f92672>.</span><span style=color:#a6e22e>setResponseCode</span><span style=color:#f92672>(((</span>MQBrokerException<span style=color:#f92672>)</span> exception<span style=color:#f92672>).</span><span style=color:#a6e22e>getResponseCode</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>exception <span style=color:#66d9ef>instanceof</span> RemotingConnectException<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                mqClientException<span style=color:#f92672>.</span><span style=color:#a6e22e>setResponseCode</span><span style=color:#f92672>(</span>ClientErrorCode<span style=color:#f92672>.</span><span style=color:#a6e22e>CONNECT_BROKER_EXCEPTION</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>exception <span style=color:#66d9ef>instanceof</span> RemotingTimeoutException<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                mqClientException<span style=color:#f92672>.</span><span style=color:#a6e22e>setResponseCode</span><span style=color:#f92672>(</span>ClientErrorCode<span style=color:#f92672>.</span><span style=color:#a6e22e>ACCESS_BROKER_TIMEOUT</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>exception <span style=color:#66d9ef>instanceof</span> MQClientException<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                mqClientException<span style=color:#f92672>.</span><span style=color:#a6e22e>setResponseCode</span><span style=color:#f92672>(</span>ClientErrorCode<span style=color:#f92672>.</span><span style=color:#a6e22e>BROKER_NOT_EXIST_EXCEPTION</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> mqClientException<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//.... ä¸‹é¢ä»£ç  çœç•¥ åªçœ‹æ ¸å¿ƒä»£ç 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=defaultmqproducerimplsendkernelimpl-è¿™ä¸ªæ–¹æ³•æ˜¯æ ¸å¿ƒå‘é€æ–¹æ³•>DefaultMQProducerImpl.sendKernelImpl è¿™ä¸ªæ–¹æ³•æ˜¯æ ¸å¿ƒå‘é€æ–¹æ³•</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> SendResult <span style=color:#a6e22e>sendKernelImpl</span><span style=color:#f92672>(</span><span style=color:#66d9ef>final</span> Message msg<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> MessageQueue mq<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> CommunicationMode communicationMode<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> SendCallback sendCallback<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> TopicPublishInfo topicPublishInfo<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>long</span> timeout<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> MQClientException<span style=color:#f92672>,</span> RemotingException<span style=color:#f92672>,</span> MQBrokerException<span style=color:#f92672>,</span> InterruptedException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>long</span> beginStartTime <span style=color:#f92672>=</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>currentTimeMillis</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//æ‰¾å¯»brokeråœ°å€
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        String brokerAddr <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>mQClientFactory</span><span style=color:#f92672>.</span><span style=color:#a6e22e>findBrokerAddressInPublish</span><span style=color:#f92672>(</span>mq<span style=color:#f92672>.</span><span style=color:#a6e22e>getBrokerName</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>null</span> <span style=color:#f92672>==</span> brokerAddr<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            tryToFindTopicPublishInfo<span style=color:#f92672>(</span>mq<span style=color:#f92672>.</span><span style=color:#a6e22e>getTopic</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>            brokerAddr <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>mQClientFactory</span><span style=color:#f92672>.</span><span style=color:#a6e22e>findBrokerAddressInPublish</span><span style=color:#f92672>(</span>mq<span style=color:#f92672>.</span><span style=color:#a6e22e>getBrokerName</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        SendMessageContext context <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>brokerAddr <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            brokerAddr <span style=color:#f92672>=</span> MixAll<span style=color:#f92672>.</span><span style=color:#a6e22e>brokerVIPChannel</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>defaultMQProducer</span><span style=color:#f92672>.</span><span style=color:#a6e22e>isSendMessageWithVIPChannel</span><span style=color:#f92672>(),</span> brokerAddr<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> prevBody <span style=color:#f92672>=</span> msg<span style=color:#f92672>.</span><span style=color:#a6e22e>getBody</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>//for MessageBatch,ID has been set in the generating process
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!(</span>msg <span style=color:#66d9ef>instanceof</span> MessageBatch<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    MessageClientIDSetter<span style=color:#f92672>.</span><span style=color:#a6e22e>setUniqID</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>boolean</span> topicWithNamespace <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>null</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>mQClientFactory</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getClientConfig</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getNamespace</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    msg<span style=color:#f92672>.</span><span style=color:#a6e22e>setInstanceId</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>mQClientFactory</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getClientConfig</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getNamespace</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>                    topicWithNamespace <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>int</span> sysFlag <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>boolean</span> msgBodyCompressed <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>tryToCompressMessage</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    sysFlag <span style=color:#f92672>|=</span> MessageSysFlag<span style=color:#f92672>.</span><span style=color:#a6e22e>COMPRESSED_FLAG</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                    msgBodyCompressed <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>final</span> String tranMsg <span style=color:#f92672>=</span> msg<span style=color:#f92672>.</span><span style=color:#a6e22e>getProperty</span><span style=color:#f92672>(</span>MessageConst<span style=color:#f92672>.</span><span style=color:#a6e22e>PROPERTY_TRANSACTION_PREPARED</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>tranMsg <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> Boolean<span style=color:#f92672>.</span><span style=color:#a6e22e>parseBoolean</span><span style=color:#f92672>(</span>tranMsg<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    sysFlag <span style=color:#f92672>|=</span> MessageSysFlag<span style=color:#f92672>.</span><span style=color:#a6e22e>TRANSACTION_PREPARED_TYPE</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>hasCheckForbiddenHook<span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    CheckForbiddenContext checkForbiddenContext <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> CheckForbiddenContext<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                    checkForbiddenContext<span style=color:#f92672>.</span><span style=color:#a6e22e>setNameSrvAddr</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>defaultMQProducer</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getNamesrvAddr</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>                    checkForbiddenContext<span style=color:#f92672>.</span><span style=color:#a6e22e>setGroup</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>defaultMQProducer</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getProducerGroup</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>                    checkForbiddenContext<span style=color:#f92672>.</span><span style=color:#a6e22e>setCommunicationMode</span><span style=color:#f92672>(</span>communicationMode<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    checkForbiddenContext<span style=color:#f92672>.</span><span style=color:#a6e22e>setBrokerAddr</span><span style=color:#f92672>(</span>brokerAddr<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    checkForbiddenContext<span style=color:#f92672>.</span><span style=color:#a6e22e>setMessage</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    checkForbiddenContext<span style=color:#f92672>.</span><span style=color:#a6e22e>setMq</span><span style=color:#f92672>(</span>mq<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    checkForbiddenContext<span style=color:#f92672>.</span><span style=color:#a6e22e>setUnitMode</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>isUnitMode</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>executeCheckForbiddenHook</span><span style=color:#f92672>(</span>checkForbiddenContext<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>hasSendMessageHook</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    context <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> SendMessageContext<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                    context<span style=color:#f92672>.</span><span style=color:#a6e22e>setProducer</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    context<span style=color:#f92672>.</span><span style=color:#a6e22e>setProducerGroup</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>defaultMQProducer</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getProducerGroup</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>                    context<span style=color:#f92672>.</span><span style=color:#a6e22e>setCommunicationMode</span><span style=color:#f92672>(</span>communicationMode<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    context<span style=color:#f92672>.</span><span style=color:#a6e22e>setBornHost</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>defaultMQProducer</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getClientIP</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>                    context<span style=color:#f92672>.</span><span style=color:#a6e22e>setBrokerAddr</span><span style=color:#f92672>(</span>brokerAddr<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    context<span style=color:#f92672>.</span><span style=color:#a6e22e>setMessage</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    context<span style=color:#f92672>.</span><span style=color:#a6e22e>setMq</span><span style=color:#f92672>(</span>mq<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    context<span style=color:#f92672>.</span><span style=color:#a6e22e>setNamespace</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>defaultMQProducer</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getNamespace</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>                    String isTrans <span style=color:#f92672>=</span> msg<span style=color:#f92672>.</span><span style=color:#a6e22e>getProperty</span><span style=color:#f92672>(</span>MessageConst<span style=color:#f92672>.</span><span style=color:#a6e22e>PROPERTY_TRANSACTION_PREPARED</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>isTrans <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> isTrans<span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;true&#34;</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                        context<span style=color:#f92672>.</span><span style=color:#a6e22e>setMsgType</span><span style=color:#f92672>(</span>MessageType<span style=color:#f92672>.</span><span style=color:#a6e22e>Trans_Msg_Half</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>msg<span style=color:#f92672>.</span><span style=color:#a6e22e>getProperty</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;__STARTDELIVERTIME&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>||</span> msg<span style=color:#f92672>.</span><span style=color:#a6e22e>getProperty</span><span style=color:#f92672>(</span>MessageConst<span style=color:#f92672>.</span><span style=color:#a6e22e>PROPERTY_DELAY_TIME_LEVEL</span><span style=color:#f92672>)</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                        context<span style=color:#f92672>.</span><span style=color:#a6e22e>setMsgType</span><span style=color:#f92672>(</span>MessageType<span style=color:#f92672>.</span><span style=color:#a6e22e>Delay_Msg</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>executeSendMessageHookBefore</span><span style=color:#f92672>(</span>context<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                SendMessageRequestHeader requestHeader <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> SendMessageRequestHeader<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                requestHeader<span style=color:#f92672>.</span><span style=color:#a6e22e>setProducerGroup</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>defaultMQProducer</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getProducerGroup</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>                requestHeader<span style=color:#f92672>.</span><span style=color:#a6e22e>setTopic</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>.</span><span style=color:#a6e22e>getTopic</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>                requestHeader<span style=color:#f92672>.</span><span style=color:#a6e22e>setDefaultTopic</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>defaultMQProducer</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getCreateTopicKey</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>                requestHeader<span style=color:#f92672>.</span><span style=color:#a6e22e>setDefaultTopicQueueNums</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>defaultMQProducer</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getDefaultTopicQueueNums</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>                requestHeader<span style=color:#f92672>.</span><span style=color:#a6e22e>setQueueId</span><span style=color:#f92672>(</span>mq<span style=color:#f92672>.</span><span style=color:#a6e22e>getQueueId</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>                requestHeader<span style=color:#f92672>.</span><span style=color:#a6e22e>setSysFlag</span><span style=color:#f92672>(</span>sysFlag<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                requestHeader<span style=color:#f92672>.</span><span style=color:#a6e22e>setBornTimestamp</span><span style=color:#f92672>(</span>System<span style=color:#f92672>.</span><span style=color:#a6e22e>currentTimeMillis</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>                requestHeader<span style=color:#f92672>.</span><span style=color:#a6e22e>setFlag</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>.</span><span style=color:#a6e22e>getFlag</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>                requestHeader<span style=color:#f92672>.</span><span style=color:#a6e22e>setProperties</span><span style=color:#f92672>(</span>MessageDecoder<span style=color:#f92672>.</span><span style=color:#a6e22e>messageProperties2String</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>.</span><span style=color:#a6e22e>getProperties</span><span style=color:#f92672>()));</span>
</span></span><span style=display:flex><span>                requestHeader<span style=color:#f92672>.</span><span style=color:#a6e22e>setReconsumeTimes</span><span style=color:#f92672>(</span>0<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                requestHeader<span style=color:#f92672>.</span><span style=color:#a6e22e>setUnitMode</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>isUnitMode</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>                requestHeader<span style=color:#f92672>.</span><span style=color:#a6e22e>setBatch</span><span style=color:#f92672>(</span>msg <span style=color:#66d9ef>instanceof</span> MessageBatch<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>requestHeader<span style=color:#f92672>.</span><span style=color:#a6e22e>getTopic</span><span style=color:#f92672>().</span><span style=color:#a6e22e>startsWith</span><span style=color:#f92672>(</span>MixAll<span style=color:#f92672>.</span><span style=color:#a6e22e>RETRY_GROUP_TOPIC_PREFIX</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    String reconsumeTimes <span style=color:#f92672>=</span> MessageAccessor<span style=color:#f92672>.</span><span style=color:#a6e22e>getReconsumeTime</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>reconsumeTimes <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                        requestHeader<span style=color:#f92672>.</span><span style=color:#a6e22e>setReconsumeTimes</span><span style=color:#f92672>(</span>Integer<span style=color:#f92672>.</span><span style=color:#a6e22e>valueOf</span><span style=color:#f92672>(</span>reconsumeTimes<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>                        MessageAccessor<span style=color:#f92672>.</span><span style=color:#a6e22e>clearProperty</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>,</span> MessageConst<span style=color:#f92672>.</span><span style=color:#a6e22e>PROPERTY_RECONSUME_TIME</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    String maxReconsumeTimes <span style=color:#f92672>=</span> MessageAccessor<span style=color:#f92672>.</span><span style=color:#a6e22e>getMaxReconsumeTimes</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>maxReconsumeTimes <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                        requestHeader<span style=color:#f92672>.</span><span style=color:#a6e22e>setMaxReconsumeTimes</span><span style=color:#f92672>(</span>Integer<span style=color:#f92672>.</span><span style=color:#a6e22e>valueOf</span><span style=color:#f92672>(</span>maxReconsumeTimes<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>                        MessageAccessor<span style=color:#f92672>.</span><span style=color:#a6e22e>clearProperty</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>,</span> MessageConst<span style=color:#f92672>.</span><span style=color:#a6e22e>PROPERTY_MAX_RECONSUME_TIMES</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                SendResult sendResult <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>switch</span> <span style=color:#f92672>(</span>communicationMode<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>case</span> ASYNC<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                        Message tmpMessage <span style=color:#f92672>=</span> msg<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>boolean</span> messageCloned <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>msgBodyCompressed<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                            <span style=color:#75715e>//If msg body was compressed, msgbody should be reset using prevBody.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                            <span style=color:#75715e>//Clone new message using commpressed message body and recover origin massage.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                            <span style=color:#75715e>//Fix bug:https://github.com/apache/rocketmq-externals/issues/66
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                            tmpMessage <span style=color:#f92672>=</span> MessageAccessor<span style=color:#f92672>.</span><span style=color:#a6e22e>cloneMessage</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                            messageCloned <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                            msg<span style=color:#f92672>.</span><span style=color:#a6e22e>setBody</span><span style=color:#f92672>(</span>prevBody<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>topicWithNamespace<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>messageCloned<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                                tmpMessage <span style=color:#f92672>=</span> MessageAccessor<span style=color:#f92672>.</span><span style=color:#a6e22e>cloneMessage</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                                messageCloned <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                            msg<span style=color:#f92672>.</span><span style=color:#a6e22e>setTopic</span><span style=color:#f92672>(</span>NamespaceUtil<span style=color:#f92672>.</span><span style=color:#a6e22e>withoutNamespace</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>.</span><span style=color:#a6e22e>getTopic</span><span style=color:#f92672>(),</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>defaultMQProducer</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getNamespace</span><span style=color:#f92672>()));</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>long</span> costTimeAsync <span style=color:#f92672>=</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>currentTimeMillis</span><span style=color:#f92672>()</span> <span style=color:#f92672>-</span> beginStartTime<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>timeout <span style=color:#f92672>&lt;</span> costTimeAsync<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RemotingTooMuchRequestException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;sendKernelImpl call timeout&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                        <span style=color:#75715e>//çœŸæ­£çš„æ ¸å¿ƒå‘é€æ–¹æ³• æ˜¯ rocketMQ é€šç”¨çš„ç½‘ç»œå±‚å·¥å…·åœ¨ç­¾åä»‹ç»è¿‡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        sendResult <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>mQClientFactory</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getMQClientAPIImpl</span><span style=color:#f92672>().</span><span style=color:#a6e22e>sendMessage</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>                            brokerAddr<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                            mq<span style=color:#f92672>.</span><span style=color:#a6e22e>getBrokerName</span><span style=color:#f92672>(),</span>
</span></span><span style=display:flex><span>                            tmpMessage<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                            requestHeader<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                            timeout <span style=color:#f92672>-</span> costTimeAsync<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                            communicationMode<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                            sendCallback<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                            topicPublishInfo<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>mQClientFactory</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>defaultMQProducer</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getRetryTimesWhenSendAsyncFailed</span><span style=color:#f92672>(),</span>
</span></span><span style=display:flex><span>                            context<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>this</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>case</span> ONEWAY<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>case</span> SYNC<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>long</span> costTimeSync <span style=color:#f92672>=</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>currentTimeMillis</span><span style=color:#f92672>()</span> <span style=color:#f92672>-</span> beginStartTime<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>timeout <span style=color:#f92672>&lt;</span> costTimeSync<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RemotingTooMuchRequestException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;sendKernelImpl call timeout&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                        sendResult <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>mQClientFactory</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getMQClientAPIImpl</span><span style=color:#f92672>().</span><span style=color:#a6e22e>sendMessage</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>                            brokerAddr<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                            mq<span style=color:#f92672>.</span><span style=color:#a6e22e>getBrokerName</span><span style=color:#f92672>(),</span>
</span></span><span style=display:flex><span>                            msg<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                            requestHeader<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                            timeout <span style=color:#f92672>-</span> costTimeSync<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                            communicationMode<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                            context<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>this</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>assert</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>hasSendMessageHook</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    context<span style=color:#f92672>.</span><span style=color:#a6e22e>setSendResult</span><span style=color:#f92672>(</span>sendResult<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>executeSendMessageHookAfter</span><span style=color:#f92672>(</span>context<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> sendResult<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>RemotingException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>hasSendMessageHook</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    context<span style=color:#f92672>.</span><span style=color:#a6e22e>setException</span><span style=color:#f92672>(</span>e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>executeSendMessageHookAfter</span><span style=color:#f92672>(</span>context<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>throw</span> e<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>MQBrokerException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>hasSendMessageHook</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    context<span style=color:#f92672>.</span><span style=color:#a6e22e>setException</span><span style=color:#f92672>(</span>e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>executeSendMessageHookAfter</span><span style=color:#f92672>(</span>context<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>throw</span> e<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>InterruptedException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>hasSendMessageHook</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    context<span style=color:#f92672>.</span><span style=color:#a6e22e>setException</span><span style=color:#f92672>(</span>e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>executeSendMessageHookAfter</span><span style=color:#f92672>(</span>context<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>throw</span> e<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                msg<span style=color:#f92672>.</span><span style=color:#a6e22e>setBody</span><span style=color:#f92672>(</span>prevBody<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                msg<span style=color:#f92672>.</span><span style=color:#a6e22e>setTopic</span><span style=color:#f92672>(</span>NamespaceUtil<span style=color:#f92672>.</span><span style=color:#a6e22e>withoutNamespace</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>.</span><span style=color:#a6e22e>getTopic</span><span style=color:#f92672>(),</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>defaultMQProducer</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getNamespace</span><span style=color:#f92672>()));</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> MQClientException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;The broker[&#34;</span> <span style=color:#f92672>+</span> mq<span style=color:#f92672>.</span><span style=color:#a6e22e>getBrokerName</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;] not exist&#34;</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=mqclientapiimplsendmessage--å’Œ-mqclientapiimplsendmessagesync>MQClientAPIImpl.sendMessage å’Œ MQClientAPIImpl.sendMessageSync</h3><p>å¯ä»¥å‘ç° ä¸‹é¢çš„å‘é€ <code>MQClientAPIImpl.sendMessage</code> -> <code>MQClientAPIImpl.sendMessageSync</code>
ï¼Œæœ€åå§”æ‰˜ç»™ <code>netty</code> çš„ï¼Œå½“ç„¶åœ¨é‡Œé¢è¿˜æœ‰ å¦‚ä½•å®ç° <code>Async</code> ã€<code>Sync</code>ã€<code>Oneway</code> å‘é€çš„ï¼Œæƒ³æ·±ç©¶çš„è¯å¯ä»¥å…·ä½“æ·±å…¥.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> SendResult <span style=color:#a6e22e>sendMessage</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> String addr<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> String brokerName<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> Message msg<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> SendMessageRequestHeader requestHeader<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>long</span> timeoutMillis<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> CommunicationMode communicationMode<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> SendCallback sendCallback<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> TopicPublishInfo topicPublishInfo<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> MQClientInstance instance<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> retryTimesWhenSendFailed<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> SendMessageContext context<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> DefaultMQProducerImpl producer
</span></span><span style=display:flex><span>    <span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> RemotingException<span style=color:#f92672>,</span> MQBrokerException<span style=color:#f92672>,</span> InterruptedException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>long</span> beginStartTime <span style=color:#f92672>=</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>currentTimeMillis</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        RemotingCommand request <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        String msgType <span style=color:#f92672>=</span> msg<span style=color:#f92672>.</span><span style=color:#a6e22e>getProperty</span><span style=color:#f92672>(</span>MessageConst<span style=color:#f92672>.</span><span style=color:#a6e22e>PROPERTY_MESSAGE_TYPE</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>boolean</span> isReply <span style=color:#f92672>=</span> msgType <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> msgType<span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>MixAll<span style=color:#f92672>.</span><span style=color:#a6e22e>REPLY_MESSAGE_FLAG</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>isReply<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>sendSmartMsg<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                SendMessageRequestHeaderV2 requestHeaderV2 <span style=color:#f92672>=</span> SendMessageRequestHeaderV2<span style=color:#f92672>.</span><span style=color:#a6e22e>createSendMessageRequestHeaderV2</span><span style=color:#f92672>(</span>requestHeader<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                request <span style=color:#f92672>=</span> RemotingCommand<span style=color:#f92672>.</span><span style=color:#a6e22e>createRequestCommand</span><span style=color:#f92672>(</span>RequestCode<span style=color:#f92672>.</span><span style=color:#a6e22e>SEND_REPLY_MESSAGE_V2</span><span style=color:#f92672>,</span> requestHeaderV2<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                request <span style=color:#f92672>=</span> RemotingCommand<span style=color:#f92672>.</span><span style=color:#a6e22e>createRequestCommand</span><span style=color:#f92672>(</span>RequestCode<span style=color:#f92672>.</span><span style=color:#a6e22e>SEND_REPLY_MESSAGE</span><span style=color:#f92672>,</span> requestHeader<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>sendSmartMsg <span style=color:#f92672>||</span> msg <span style=color:#66d9ef>instanceof</span> MessageBatch<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                SendMessageRequestHeaderV2 requestHeaderV2 <span style=color:#f92672>=</span> SendMessageRequestHeaderV2<span style=color:#f92672>.</span><span style=color:#a6e22e>createSendMessageRequestHeaderV2</span><span style=color:#f92672>(</span>requestHeader<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                request <span style=color:#f92672>=</span> RemotingCommand<span style=color:#f92672>.</span><span style=color:#a6e22e>createRequestCommand</span><span style=color:#f92672>(</span>msg <span style=color:#66d9ef>instanceof</span> MessageBatch <span style=color:#f92672>?</span> RequestCode<span style=color:#f92672>.</span><span style=color:#a6e22e>SEND_BATCH_MESSAGE</span> <span style=color:#f92672>:</span> RequestCode<span style=color:#f92672>.</span><span style=color:#a6e22e>SEND_MESSAGE_V2</span><span style=color:#f92672>,</span> requestHeaderV2<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                request <span style=color:#f92672>=</span> RemotingCommand<span style=color:#f92672>.</span><span style=color:#a6e22e>createRequestCommand</span><span style=color:#f92672>(</span>RequestCode<span style=color:#f92672>.</span><span style=color:#a6e22e>SEND_MESSAGE</span><span style=color:#f92672>,</span> requestHeader<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        request<span style=color:#f92672>.</span><span style=color:#a6e22e>setBody</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>.</span><span style=color:#a6e22e>getBody</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>switch</span> <span style=color:#f92672>(</span>communicationMode<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> ONEWAY<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>remotingClient</span><span style=color:#f92672>.</span><span style=color:#a6e22e>invokeOneway</span><span style=color:#f92672>(</span>addr<span style=color:#f92672>,</span> request<span style=color:#f92672>,</span> timeoutMillis<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> ASYNC<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>final</span> AtomicInteger times <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> AtomicInteger<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>long</span> costTimeAsync <span style=color:#f92672>=</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>currentTimeMillis</span><span style=color:#f92672>()</span> <span style=color:#f92672>-</span> beginStartTime<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>timeoutMillis <span style=color:#f92672>&lt;</span> costTimeAsync<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RemotingTooMuchRequestException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;sendMessage call timeout&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>sendMessageAsync</span><span style=color:#f92672>(</span>addr<span style=color:#f92672>,</span> brokerName<span style=color:#f92672>,</span> msg<span style=color:#f92672>,</span> timeoutMillis <span style=color:#f92672>-</span> costTimeAsync<span style=color:#f92672>,</span> request<span style=color:#f92672>,</span> sendCallback<span style=color:#f92672>,</span> topicPublishInfo<span style=color:#f92672>,</span> instance<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                    retryTimesWhenSendFailed<span style=color:#f92672>,</span> times<span style=color:#f92672>,</span> context<span style=color:#f92672>,</span> producer<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> SYNC<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>long</span> costTimeSync <span style=color:#f92672>=</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>currentTimeMillis</span><span style=color:#f92672>()</span> <span style=color:#f92672>-</span> beginStartTime<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>timeoutMillis <span style=color:#f92672>&lt;</span> costTimeSync<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RemotingTooMuchRequestException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;sendMessage call timeout&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>sendMessageSync</span><span style=color:#f92672>(</span>addr<span style=color:#f92672>,</span> brokerName<span style=color:#f92672>,</span> msg<span style=color:#f92672>,</span> timeoutMillis <span style=color:#f92672>-</span> costTimeSync<span style=color:#f92672>,</span> request<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>assert</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> SendResult <span style=color:#a6e22e>sendMessageSync</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> String addr<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> String brokerName<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> Message msg<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>long</span> timeoutMillis<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> RemotingCommand request
</span></span><span style=display:flex><span>    <span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> RemotingException<span style=color:#f92672>,</span> MQBrokerException<span style=color:#f92672>,</span> InterruptedException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        RemotingCommand response <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>remotingClient</span><span style=color:#f92672>.</span><span style=color:#a6e22e>invokeSync</span><span style=color:#f92672>(</span>addr<span style=color:#f92672>,</span> request<span style=color:#f92672>,</span> timeoutMillis<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>assert</span> response <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>processSendResponse</span><span style=color:#f92672>(</span>brokerName<span style=color:#f92672>,</span> msg<span style=color:#f92672>,</span> response<span style=color:#f92672>,</span>addr<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><h1 id=producer-å’Œ-namesever-å¦‚ä½•äº¤äº’>Producer å’Œ NameSever å¦‚ä½•äº¤äº’</h1><ul><li>åœ¨ <code>Producer</code> å¯åŠ¨ å’Œ å‘é€æ¶ˆæ¯çš„ ä»£ç èµ°è¯»çš„æ—¶å€™ï¼Œåº”è¯¥ç•™æ„äº† <code>TopicPublishInfo</code> è¿™ä¸ªç±»</li></ul><p><code>DefaultMQProducerImpl.sendDefaultImpl</code>
->
<code>DefaultMQProducerImpl.tryToFindTopicPublishInfo</code>
->
<code>MQClientInstance.updateTopicRouteInfoFromNameServer</code>
->
<code>MQClientAPIImpl.getTopicRouteInfoFromNameServer</code></p><p>çœ‹åˆ°å…ˆä»ç¼“å­˜è·å–è·¯ç”±ä¿¡æ¯ï¼Œå‘ç°æ²¡æœ‰çš„è¯ å†ä» <code>NameServer</code> è·å–(<code>this.mQClientFactory.updateTopicRouteInfoFromNameServer(topic);</code>)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>     <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * è·å– topic å¯¹åº”çš„è·¯ç”±ä¿¡æ¯
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param topic
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> TopicPublishInfo <span style=color:#a6e22e>tryToFindTopicPublishInfo</span><span style=color:#f92672>(</span><span style=color:#66d9ef>final</span> String topic<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//ä»ç¼“å­˜ä¸­è·å–è·¯ç”±ä¿¡æ¯
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        TopicPublishInfo topicPublishInfo <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>topicPublishInfoTable</span><span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>topic<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//å¦‚æœæœ¬åœ°ç¼“å­˜çš„è·¯ç”±ä¿¡æ¯æ—  æˆ–è€… ä¸æ˜¯å°†åº·çš„
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>null</span> <span style=color:#f92672>==</span> topicPublishInfo <span style=color:#f92672>||</span> <span style=color:#f92672>!</span>topicPublishInfo<span style=color:#f92672>.</span><span style=color:#a6e22e>ok</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>topicPublishInfoTable</span><span style=color:#f92672>.</span><span style=color:#a6e22e>putIfAbsent</span><span style=color:#f92672>(</span>topic<span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> TopicPublishInfo<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>//ä» NameServer è·å– Topicä¿¡æ¯è¿›è¡Œæ›´æ–°æ›´æ–°åˆ°æœ¬åœ°ç¼“å­˜ä¸­
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>mQClientFactory</span><span style=color:#f92672>.</span><span style=color:#a6e22e>updateTopicRouteInfoFromNameServer</span><span style=color:#f92672>(</span>topic<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            topicPublishInfo <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>topicPublishInfoTable</span><span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>topic<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>topicPublishInfo<span style=color:#f92672>.</span><span style=color:#a6e22e>isHaveTopicRouterInfo</span><span style=color:#f92672>()</span> <span style=color:#f92672>||</span> topicPublishInfo<span style=color:#f92672>.</span><span style=color:#a6e22e>ok</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> topicPublishInfo<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>//ä» NameServer è·å– Topicä¿¡æ¯è¿›è¡Œæ›´æ–°æ›´æ–°åˆ°æœ¬åœ°ç¼“å­˜ä¸­
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>mQClientFactory</span><span style=color:#f92672>.</span><span style=color:#a6e22e>updateTopicRouteInfoFromNameServer</span><span style=color:#f92672>(</span>topic<span style=color:#f92672>,</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>defaultMQProducer</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            topicPublishInfo <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>topicPublishInfoTable</span><span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>topic<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> topicPublishInfo<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>//.... ä¸Šé¢ä»£ç  çœç•¥ åªçœ‹æ ¸å¿ƒä»£ç 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        TopicRouteData topicRouteData<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>isDefault <span style=color:#f92672>&amp;&amp;</span> defaultMQProducer <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            topicRouteData <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>mQClientAPIImpl</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getDefaultTopicRouteInfoFromNameServer</span><span style=color:#f92672>(</span>defaultMQProducer<span style=color:#f92672>.</span><span style=color:#a6e22e>getCreateTopicKey</span><span style=color:#f92672>(),</span> 1000 <span style=color:#f92672>*</span> 3<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>topicRouteData <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>QueueData data <span style=color:#f92672>:</span> topicRouteData<span style=color:#f92672>.</span><span style=color:#a6e22e>getQueueDatas</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>int</span> queueNums <span style=color:#f92672>=</span> Math<span style=color:#f92672>.</span><span style=color:#a6e22e>min</span><span style=color:#f92672>(</span>defaultMQProducer<span style=color:#f92672>.</span><span style=color:#a6e22e>getDefaultTopicQueueNums</span><span style=color:#f92672>(),</span> data<span style=color:#f92672>.</span><span style=color:#a6e22e>getReadQueueNums</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>                    data<span style=color:#f92672>.</span><span style=color:#a6e22e>setReadQueueNums</span><span style=color:#f92672>(</span>queueNums<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    data<span style=color:#f92672>.</span><span style=color:#a6e22e>setWriteQueueNums</span><span style=color:#f92672>(</span>queueNums<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            topicRouteData <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>mQClientAPIImpl</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getTopicRouteInfoFromNameServer</span><span style=color:#f92672>(</span>topic<span style=color:#f92672>,</span> 1000 <span style=color:#f92672>*</span> 3<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//.... ä¸‹é¢ä»£ç  çœç•¥ åªçœ‹æ ¸å¿ƒä»£ç 
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#66d9ef>public</span> TopicRouteData <span style=color:#a6e22e>getTopicRouteInfoFromNameServer</span><span style=color:#f92672>(</span><span style=color:#66d9ef>final</span> String topic<span style=color:#f92672>,</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>long</span> timeoutMillis<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>boolean</span> allowTopicNotExist<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> MQClientException<span style=color:#f92672>,</span> InterruptedException<span style=color:#f92672>,</span> RemotingTimeoutException<span style=color:#f92672>,</span> RemotingSendRequestException<span style=color:#f92672>,</span> RemotingConnectException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        GetRouteInfoRequestHeader requestHeader <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> GetRouteInfoRequestHeader<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        requestHeader<span style=color:#f92672>.</span><span style=color:#a6e22e>setTopic</span><span style=color:#f92672>(</span>topic<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//æ„å»ºå‘ NameServer å‘é€çš„æ¶ˆæ¯ä½“
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        RemotingCommand request <span style=color:#f92672>=</span> RemotingCommand<span style=color:#f92672>.</span><span style=color:#a6e22e>createRequestCommand</span><span style=color:#f92672>(</span>RequestCode<span style=color:#f92672>.</span><span style=color:#a6e22e>GET_ROUTEINFO_BY_TOPIC</span><span style=color:#f92672>,</span> requestHeader<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//å¼€å§‹å‘é€è¯·æ±‚å¹¶ä¸”æ˜¯åŒæ­¥çš„æ–¹å¼
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        RemotingCommand response <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>remotingClient</span><span style=color:#f92672>.</span><span style=color:#a6e22e>invokeSync</span><span style=color:#f92672>(</span><span style=color:#66d9ef>null</span><span style=color:#f92672>,</span> request<span style=color:#f92672>,</span> timeoutMillis<span style=color:#f92672>);</span><span style=color:#66d9ef>assert</span> response <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>assert</span> response <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>switch</span> <span style=color:#f92672>(</span>response<span style=color:#f92672>.</span><span style=color:#a6e22e>getCode</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> ResponseCode<span style=color:#f92672>.</span><span style=color:#a6e22e>TOPIC_NOT_EXIST</span><span style=color:#f92672>:</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>allowTopicNotExist<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    log<span style=color:#f92672>.</span><span style=color:#a6e22e>warn</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;get Topic [{}] RouteInfoFromNameServer is not exist value&#34;</span><span style=color:#f92672>,</span> topic<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> ResponseCode<span style=color:#f92672>.</span><span style=color:#a6e22e>SUCCESS</span><span style=color:#f92672>:</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> body <span style=color:#f92672>=</span> response<span style=color:#f92672>.</span><span style=color:#a6e22e>getBody</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>body <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>return</span> TopicRouteData<span style=color:#f92672>.</span><span style=color:#a6e22e>decode</span><span style=color:#f92672>(</span>body<span style=color:#f92672>,</span> TopicRouteData<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> MQClientException<span style=color:#f92672>(</span>response<span style=color:#f92672>.</span><span style=color:#a6e22e>getCode</span><span style=color:#f92672>(),</span> response<span style=color:#f92672>.</span><span style=color:#a6e22e>getRemark</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><h1 id=producer-å‘é€æ¶ˆæ¯å¦‚ä½•ä¿è¯é¡ºåº>Producer å‘é€æ¶ˆæ¯å¦‚ä½•ä¿è¯é¡ºåº</h1><p><code>RocketMQ</code> å‘é€çš„æ¶ˆæ¯æ”¯æŒæ˜¯æœ‰åºçš„ï¼Œæ¶ˆè´¹æ¶ˆæ¯çš„é¡ºåºå’Œå‘é€æ¶ˆæ¯çš„é¡ºåºä¸€è‡´çš„ã€‚å½“ç„¶ <code>Producer</code> å‘é€çš„æ¶ˆæ¯è¦æœ‰åºï¼Œæ˜¯å±€éƒ¨æ¶ˆæ¯æœ‰åºï¼Œè¦ä¿è¯å‘é€åˆ°åŒä¸€ä¸ªTopicä¸‹çš„åŒä¸€ä¸ªQueueï¼Œè¿™æ · <code>Consumer</code> å¯ä»¥æŒ‰ç…§ <code>Producer</code> å‘é€çš„æ¶ˆæ¯é¡ºåºè¿›è¡Œæ¶ˆè´¹ã€‚</p><ul><li>æ™®é€šé¡ºåºæ¶ˆæ¯</li></ul><blockquote><p>æ­£å¸¸æƒ…å†µä¸‹ä¿è¯å®Œå…¨çš„é¡ºåºæ¶ˆæ¯, ä½†æ˜¯å¦‚æœå‘ç”Ÿé€šè®¯å¼‚å¸¸(Brokeré‡å¯ç­‰),ç”±äºé˜Ÿåˆ—çš„æ€»æ•°å‘é€å˜åŒ–ã€‚å“ˆå¸Œå–æ¨¡åå®šä½çš„é˜Ÿåˆ—ä¹Ÿä¼šå‘ç”Ÿå˜åŒ–ï¼Œäº§ç”Ÿçš„æ¶ˆæ¯å¯èƒ½çŸ­æš‚çš„æ¶ˆæ¯é¡ºåºä¸ä¸€è‡´ã€‚</p></blockquote><ul><li>ä¸¥æ ¼é¡ºåºæ¶ˆæ¯</li></ul><blockquote><p>æ— è®ºæ­£å¸¸å¼‚å¸¸æƒ…å†µéƒ½ä¿è¯é¡ºåºä¸€è‡´, ä½†æ˜¯ç‰ºç‰²äº†åˆ†å¸ƒå¼çš„ Failover ç‰¹æ€§ï¼ˆBrokeré›†ç¾¤åªè¦æœ‰ä¸€å°ä¸å¯ç”¨ï¼Œæ•´ä¸ªé›†ç¾¤éƒ½ä¸å¯ç”¨, æœåŠ¡å¯ç”¨æ€§å¤§å¤§é™ä½ï¼‰
è¦ä¿è¯ä¸¥æ ¼çš„é¡ºåºæ¶ˆæ¯ï¼Œéœ€è¦ä¿è¯ Producer -> MQServer -> Consumer éƒ½æ˜¯ä¸€å¯¹ä¸€çš„å…³ç³»</p></blockquote><p>åœ¨ Producer ç«¯ä¿è¯å‘é€é¡ºåºçš„ä¸€è‡´æ€§çš„æ˜¯é€šè¿‡ä¿è¯ é¡ºåºæ¶ˆæ¯æŠŠåŒç±»å‹çš„æ¶ˆæ¯å‘é€åˆ°åŒä¸€ä¸ª <code>MessageQueue</code> å®ç°çš„ã€‚æ ¸å¿ƒä»£ç åœ¨ä» <code>send</code> æ–¹æ³•å…¥æ‰‹
<code>Producer.send </code>æœ‰ä¸ªé‡è½½çš„æ–¹æ³• <code>send(Message msg, MessageQueueSelector selector, Object arg)</code>, å‚æ•°ä¸º <code>MessageQueueSelector</code> selector , åªè¦å®ç°è¿™ä¸ªæ¥å£ï¼Œå¯ä»¥é€šè¿‡</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> SendResult <span style=color:#a6e22e>send</span><span style=color:#f92672>(</span>Message msg<span style=color:#f92672>,</span> MessageQueueSelector selector<span style=color:#f92672>,</span> Object arg<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throws</span> MQClientException<span style=color:#f92672>,</span> RemotingException<span style=color:#f92672>,</span> MQBrokerException<span style=color:#f92672>,</span> InterruptedException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        msg<span style=color:#f92672>.</span><span style=color:#a6e22e>setTopic</span><span style=color:#f92672>(</span>withNamespace<span style=color:#f92672>(</span>msg<span style=color:#f92672>.</span><span style=color:#a6e22e>getTopic</span><span style=color:#f92672>()));</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>defaultMQProducerImpl</span><span style=color:#f92672>.</span><span style=color:#a6e22e>send</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>,</span> selector<span style=color:#f92672>,</span> arg<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>MessageQueueSelector</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    MessageQueue <span style=color:#a6e22e>select</span><span style=color:#f92672>(</span><span style=color:#66d9ef>final</span> List<span style=color:#f92672>&lt;</span>MessageQueue<span style=color:#f92672>&gt;</span> mqs<span style=color:#f92672>,</span> <span style=color:#66d9ef>final</span> Message msg<span style=color:#f92672>,</span> <span style=color:#66d9ef>final</span> Object arg<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h1 id=producer-è´Ÿè½½å‡è¡¡å¦‚ä½•å®ç°çš„>Producer è´Ÿè½½å‡è¡¡å¦‚ä½•å®ç°çš„</h1><p><code>DefaultMQProducerImpl.send</code>
-> <code>DefaultMQProducerImpl.sendDefaultImpl</code>
â€”> <code>DefaultMQProducerImpl.selectOneMessageQueue</code>
-> <code>MQFaultStrategy.selectOneMessageQueue</code> (è¿™è¾¹æ˜¯ æ˜¯å¦å¼€å¯å®¹é”™ç­–ç•¥ï¼Œå³è´Ÿè½½å‡è¡¡ç­–ç•¥åœ¨å†…éƒ¨)
-> <code>TopicPublishInfo.selectOneMessageQueue</code></p><p>ä¸‹é¢åœ¨é€‰æ‹©ä½å»¶è¿Ÿçš„ Brokerï¼Œæ ¹æ® faultItem çš„å¯ç”¨æ€§å’Œå¼€å§‹æ—¶é—´é€‰æ‹©çš„</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span> <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * åœ¨ rocketMQ ä¸­ ä¸€ä¸ª Topic åŒ…å«å¤šä¸ª MessageQueue, åˆ†æ•£åœ¨ä¸åŒçš„ Brokerã€‚
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * ä¸€ä¸ª Producer å‘é€æ¶ˆæ¯çš„æ—¶å€™é¡ºåºæ˜¯è¿™æ ·çš„
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *  - 1. Producer è·å–æ¶ˆæ¯è·¯ç”±ä¿¡æ¯( å½“æœ¬åœ°ç¼“å­˜æ— è·¯ç”±ä¿¡æ¯æ—¶å€™ã€ä» NameSrv è·å–è·¯ç”±ä¿¡æ¯ )
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *  - 2. Producer å‘é€æ¶ˆæ¯åˆ° Broker
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *  - 3. Broker å­˜å‚¨å‘é€çš„æ¶ˆæ¯  ( æ ¹æ®ä¸åŒ Broker é…ç½®, å¯åŒæ­¥æˆ–å¼‚æ­¥å­˜å‚¨å‘é€æ¶ˆæ¯ )
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *  - 4. Broker å‘ Producer åé¦ˆçš„å‘é€æ¶ˆæ¯çš„ç»“æœ
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *  åœ¨è¿™ä¸ªå‘é€è¿‡ç¨‹ä¸­å¯èƒ½å­˜åœ¨å‘é€å¤±è´¥
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *  é˜Ÿåˆ—çš„é€‰æ‹©å’Œå®¹é”™ç­–ç•¥
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *  - åœ¨ä¸å¼€å¯å®¹é”™ä¸‹, è½®è¯¢é˜Ÿåˆ—è¿›è¡Œå‘é€, å¦‚æœå¤±è´¥äº†, é‡è¯•çš„æ—¶å€™è¿‡æ»¤å¤±è´¥çš„ Broker
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *  - å¦‚æœå¼€å¯äº†å®¹é”™, ä¼šé€šè¿‡ RocketMQ çš„é¢„æµ‹æœºåˆ¶æ¥é¢„æµ‹ä¸€ä¸ª Broker æ˜¯å¦å¯ç”¨
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *  - å¦‚æœä¸Šæ¬¡å¤±è´¥çš„ Broker å¯ç”¨, é‚£ä¹ˆè¿˜ç»§ç»­é€‰æ‹©è¯¥ Broker é˜Ÿåˆ—
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *  - å¦‚æœä¸Šè¿°å¤±è´¥, åˆ™éšæœºé€‰æ‹©ä¸€ä¸ª Broker è¿›è¡Œå‘é€
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *  - åœ¨å‘é€æ¶ˆæ¯çš„æ—¶å€™ä¼šè®°å½•ä¸€ä¸‹è°ƒç”¨çš„æ—¶é—´ä¸å‘é€æ˜¯å¦é”™è¯¯ï¼Œæ ¹æ®æ—¶é—´å»é¢„æµ‹ æ•…éšœçš„Broker å¯ç”¨æ—¶é—´
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param tpInfo
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param lastBrokerName
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> MessageQueue <span style=color:#a6e22e>selectOneMessageQueue</span><span style=color:#f92672>(</span><span style=color:#66d9ef>final</span> TopicPublishInfo tpInfo<span style=color:#f92672>,</span> <span style=color:#66d9ef>final</span> String lastBrokerName<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// æ˜¯å¦å¼€å¯å®¹é”™ç­–ç•¥
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>sendLatencyFaultEnable</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>//é€‰æ‹©ä¸€ä¸ªé˜Ÿåˆ—, topicInfo ThreadLocalIndex éƒ½ + 1
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>int</span> index <span style=color:#f92672>=</span> tpInfo<span style=color:#f92672>.</span><span style=color:#a6e22e>getSendWhichQueue</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getAndIncrement</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>//ä¸é˜Ÿåˆ—çš„é•¿åº¦å–æ¨¡, æ ¹æ®æœ€åçš„ pos å–ä¸€ä¸ªé˜Ÿåˆ—
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> i <span style=color:#f92672>&lt;</span> tpInfo<span style=color:#f92672>.</span><span style=color:#a6e22e>getMessageQueueList</span><span style=color:#f92672>().</span><span style=color:#a6e22e>size</span><span style=color:#f92672>();</span> i<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>int</span> pos <span style=color:#f92672>=</span> Math<span style=color:#f92672>.</span><span style=color:#a6e22e>abs</span><span style=color:#f92672>(</span>index<span style=color:#f92672>++)</span> <span style=color:#f92672>%</span> tpInfo<span style=color:#f92672>.</span><span style=color:#a6e22e>getMessageQueueList</span><span style=color:#f92672>().</span><span style=color:#a6e22e>size</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>pos <span style=color:#f92672>&lt;</span> 0<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                        pos <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                    MessageQueue mq <span style=color:#f92672>=</span> tpInfo<span style=color:#f92672>.</span><span style=color:#a6e22e>getMessageQueueList</span><span style=color:#f92672>().</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>pos<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>//åˆ¤æ–­è·å–åˆ°çš„é˜Ÿåˆ—çš„Broker æ˜¯å¦åœ¨æ•…éšœåˆ—è¡¨ä¸­, éæ•…éšœçš„åˆ™è¿”å›
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>latencyFaultTolerance<span style=color:#f92672>.</span><span style=color:#a6e22e>isAvailable</span><span style=color:#f92672>(</span>mq<span style=color:#f92672>.</span><span style=color:#a6e22e>getBrokerName</span><span style=color:#f92672>()))</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>return</span> mq<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>//ä»£ç èµ°åˆ°è¿™è¾¹, è¯´æ˜æ²¡æœ‰éæ•…éšœçš„é˜Ÿåˆ— åªèƒ½ä»æ•…éšœåˆ—è¡¨ä¸­è·å–ä¸€ä¸ªé˜Ÿåˆ—
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>//å¦‚æœè¿™ä¸ª topic ä¸‹çš„æ‰€æœ‰çš„é˜Ÿåˆ—éƒ½æ˜¯æ•…éšœçš„è¯, é‚£ä¹ˆå°±ä»æ•…éšœåˆ—è¡¨ä¸­å–å‡ºä¸€ä¸ª Broker
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>final</span> String notBestBroker <span style=color:#f92672>=</span> latencyFaultTolerance<span style=color:#f92672>.</span><span style=color:#a6e22e>pickOneAtLeast</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>//è·å–è¿™ä¸ª Broker çš„å¯å†™é˜Ÿåˆ—æ•°, å¦‚æœè¯¥ Broker æ²¡æœ‰å¯å†™çš„é˜Ÿåˆ—, åˆ™è¿”å› -1
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>int</span> writeQueueNums <span style=color:#f92672>=</span> tpInfo<span style=color:#f92672>.</span><span style=color:#a6e22e>getQueueIdByBroker</span><span style=color:#f92672>(</span>notBestBroker<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>writeQueueNums <span style=color:#f92672>&gt;</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// é€‰æ‹©é˜Ÿåˆ—, é€šè¿‡ä¸é˜Ÿåˆ—çš„é•¿åº¦å–æ¨¡ç¡®å®šé˜Ÿåˆ—çš„ä½ç½®
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#66d9ef>final</span> MessageQueue mq <span style=color:#f92672>=</span> tpInfo<span style=color:#f92672>.</span><span style=color:#a6e22e>selectOneMessageQueue</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>notBestBroker <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                        mq<span style=color:#f92672>.</span><span style=color:#a6e22e>setBrokerName</span><span style=color:#f92672>(</span>notBestBroker<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                        mq<span style=color:#f92672>.</span><span style=color:#a6e22e>setQueueId</span><span style=color:#f92672>(</span>tpInfo<span style=color:#f92672>.</span><span style=color:#a6e22e>getSendWhichQueue</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getAndIncrement</span><span style=color:#f92672>()</span> <span style=color:#f92672>%</span> writeQueueNums<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>return</span> mq<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>//æ²¡æœ‰å¯å†™çš„é˜Ÿåˆ—,ç›´æ¥ä»æ•…éšœåˆ—è¡¨ä¸­ç§»é™¤
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    latencyFaultTolerance<span style=color:#f92672>.</span><span style=color:#a6e22e>remove</span><span style=color:#f92672>(</span>notBestBroker<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Exception e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                log<span style=color:#f92672>.</span><span style=color:#a6e22e>error</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Error occurred when selecting message queue&#34;</span><span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>//å¦‚æœæ•…éšœåˆ—è¡¨ä¸­æ²¡æœ‰å¯å†™çš„é˜Ÿåˆ—, ç›´æ¥ä»Topic Publish Infoä¸­å–ä¸€ä¸ª
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>return</span> tpInfo<span style=color:#f92672>.</span><span style=color:#a6e22e>selectOneMessageQueue</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// å¦‚æœæ²¡æœ‰å¼€å¯æ•…éšœå»¶è¿Ÿ, ç›´æ¥ä» Topic Publish Info é€šè¿‡å–æ¨¡çš„æ–¹å¼è·å–é˜Ÿåˆ—,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// å¦‚æœLastBrokerNameä¸ä¸ºç©ºï¼Œåˆ™éœ€è¦è¿‡æ»¤æ‰brokerName=lastBrokerNameçš„é˜Ÿåˆ—
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// æ²¡æœ‰å¼€å¯æ•…éšœå»¶è¿Ÿçš„è¯ï¼Œèµ°è½®è¯¢æ¨¡å¼
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>return</span> tpInfo<span style=color:#f92672>.</span><span style=color:#a6e22e>selectOneMessageQueue</span><span style=color:#f92672>(</span>lastBrokerName<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>æ ¸å¿ƒåœ¨ä¸‹è¿°æ–¹æ³•ä¸­ï¼ŒTopicPublishInfo.selectOneMessageQueue</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *  è½®è¯¢æ¨¡å¼
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> MessageQueue <span style=color:#a6e22e>selectOneMessageQueue</span><span style=color:#f92672>(</span><span style=color:#66d9ef>final</span> String lastBrokerName<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>lastBrokerName <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> selectOneMessageQueue<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> i <span style=color:#f92672>&lt;</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>messageQueueList</span><span style=color:#f92672>.</span><span style=color:#a6e22e>size</span><span style=color:#f92672>();</span> i<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>int</span> index <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>sendWhichQueue</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getAndIncrement</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>int</span> pos <span style=color:#f92672>=</span> Math<span style=color:#f92672>.</span><span style=color:#a6e22e>abs</span><span style=color:#f92672>(</span>index<span style=color:#f92672>)</span> <span style=color:#f92672>%</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>messageQueueList</span><span style=color:#f92672>.</span><span style=color:#a6e22e>size</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>pos <span style=color:#f92672>&lt;</span> 0<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                    pos <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                MessageQueue mq <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>messageQueueList</span><span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>pos<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>mq<span style=color:#f92672>.</span><span style=color:#a6e22e>getBrokerName</span><span style=color:#f92672>().</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>lastBrokerName<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>return</span> mq<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> selectOneMessageQueue<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><h1 id=producer-å»¶è¿Ÿæ¶ˆæ¯å‘é€çš„æ—¶å€™è®¾ç½®messageçš„å»¶è¿Ÿçº§åˆ«>Producer å»¶è¿Ÿæ¶ˆæ¯ï¼ˆå‘é€çš„æ—¶å€™è®¾ç½®Messageçš„å»¶è¿Ÿçº§åˆ«ï¼‰</h1><p>å»¶è¿Ÿæ¶ˆæ¯</p><blockquote><p>æ¶ˆæ¯å‘é€åˆ° <code>Broker</code>, ä¸èƒ½ç«‹åˆ»è¢« <code>Consumer</code> æ¶ˆè´¹ï¼Œåªæœ‰åˆ°äº†ç‰¹å®šçš„æ—¶é—´ç‚¹æˆ–è€…ç­‰å¾…ç‰¹å®šçš„æ—¶é—´åï¼Œæ‰èƒ½è¢«æ¶ˆè´¹ã€‚</p></blockquote><p>å»¶è¿Ÿæ¶ˆæ¯ä¸¤ç§ç±»å‹</p><ul><li>å®šæ—¶æ¶ˆæ¯ ï¼ˆç‰¹å®šçš„æ—¶é—´ <code>level</code>ï¼‰</li><li>ä»»æ„çš„æ—¶é—´ç²¾åº¦çš„å»¶è¿Ÿæ¶ˆæ¯</li></ul><p><code>RocketMQ</code> ä¸æ”¯æŒ ä»»æ„æ—¶é—´åº¦çš„å»¶è¿Ÿæ¶ˆæ¯, å› ä¸ºå¦‚æœéœ€è¦æ”¯æŒï¼Œåœ¨<code>Broker</code>å±‚é¢éœ€è¦åšå¤§é‡çš„æ¶ˆæ¯æ’åºï¼Œè¿˜éœ€è¦æŒä¹…åŒ–ï¼Œé‚£ä¹ˆä¼šäº§ç”Ÿå·¨å¤§çš„æ€§èƒ½å¼€é”€ã€‚
æ‰€ä»¥ <code>RocketMQ</code> åªæ”¯æŒ å®šæ—¶æ¶ˆæ¯ã€‚</p><p>å›å¤´çœ‹ <code>Message#setDelayTimeLevel</code>æ–¹æ³•</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>     <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setDelayTimeLevel</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> level<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>putProperty</span><span style=color:#f92672>(</span>MessageConst<span style=color:#f92672>.</span><span style=color:#a6e22e>PROPERTY_DELAY_TIME_LEVEL</span><span style=color:#f92672>,</span> String<span style=color:#f92672>.</span><span style=color:#a6e22e>valueOf</span><span style=color:#f92672>(</span>level<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div></div></article><div class=blog-post-comments><div id=disqus_thread><script type=text/javascript>(function(){var t,e=document.createElement("script");e.type="text/javascript",e.async=!0,t="pinkhello",e.src="//"+t+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com/ class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div><div id=footer-post-container><div id=footer-post><div id=nav-footer style=display:none><ul><li><a href=/>Home</a></li><li><a href=/posts>Posts</a></li><li><a href=/categories>Category</a></li><li><a href=/tags>Tag</a></li><li><a href=/index.xml>Rss</a></li><li><a href=/jobs>Job</a></li></ul></div><div id=share-footer style=display:none><ul><li><a class=icon href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fpinkhello.cc%2fposts%2f27-rocketmq%25E6%25BA%2590%25E7%25A0%2581%25E9%2598%2585%25E8%25AF%25BB-producer%2f" aria-label=Facebook><i class="fab fa-facebook fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://twitter.com/share?url=https%3a%2f%2fpinkhello.cc%2fposts%2f27-rocketmq%25E6%25BA%2590%25E7%25A0%2581%25E9%2598%2585%25E8%25AF%25BB-producer%2f&text=RocketMQ%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb%20Producer" aria-label=Twitter><i class="fab fa-twitter fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fpinkhello.cc%2fposts%2f27-rocketmq%25E6%25BA%2590%25E7%25A0%2581%25E9%2598%2585%25E8%25AF%25BB-producer%2f&title=RocketMQ%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb%20Producer" aria-label=Linkedin><i class="fab fa-linkedin fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fpinkhello.cc%2fposts%2f27-rocketmq%25E6%25BA%2590%25E7%25A0%2581%25E9%2598%2585%25E8%25AF%25BB-producer%2f&is_video=false&description=RocketMQ%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb%20Producer" aria-label=Pinterest><i class="fab fa-pinterest fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="mailto:?subject=RocketMQ%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb%20Producer&body=Check out this article: https%3a%2f%2fpinkhello.cc%2fposts%2f27-rocketmq%25E6%25BA%2590%25E7%25A0%2581%25E9%2598%2585%25E8%25AF%25BB-producer%2f" aria-label=Email><i class="fas fa-envelope fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://getpocket.com/save?url=https%3a%2f%2fpinkhello.cc%2fposts%2f27-rocketmq%25E6%25BA%2590%25E7%25A0%2581%25E9%2598%2585%25E8%25AF%25BB-producer%2f&title=RocketMQ%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb%20Producer" aria-label=Pocket><i class="fab fa-get-pocket fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://reddit.com/submit?url=https%3a%2f%2fpinkhello.cc%2fposts%2f27-rocketmq%25E6%25BA%2590%25E7%25A0%2581%25E9%2598%2585%25E8%25AF%25BB-producer%2f&title=RocketMQ%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb%20Producer" aria-label=reddit><i class="fab fa-reddit fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.tumblr.com/share/link?url=https%3a%2f%2fpinkhello.cc%2fposts%2f27-rocketmq%25E6%25BA%2590%25E7%25A0%2581%25E9%2598%2585%25E8%25AF%25BB-producer%2f&name=RocketMQ%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb%20Producer&description=RocketMQ%e5%bc%80%e7%ae%b1%e6%ba%90%e7%a0%81%e8%af%a6%e8%a7%a3-Producer-%e6%88%91%e5%b0%b1%e6%98%af%e4%b8%aa%e6%89%93%e5%b7%a5%e4%ba%ba" aria-label=Tumblr><i class="fab fa-tumblr fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fpinkhello.cc%2fposts%2f27-rocketmq%25E6%25BA%2590%25E7%25A0%2581%25E9%2598%2585%25E8%25AF%25BB-producer%2f&t=RocketMQ%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb%20Producer" aria-label="Hacker News"><i class="fab fa-hacker-news fa-lg" aria-hidden=true></i></a></li></ul></div><div id=actions-footer><a id=menu-toggle class=icon href=# onclick='return $("#nav-footer").toggle(),!1' aria-label=Menu><i class="fas fa-bars fa-lg" aria-hidden=true></i> Menu</a>
<a id=share-toggle class=icon href=# onclick='return $("#share-footer").toggle(),!1' aria-label=Share><i class="fas fa-share-alt fa-lg" aria-hidden=true></i> share</a>
<a id=top style=display:none class=icon href=# onclick='$("html, body").animate({scrollTop:0},"fast")' aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg" aria-hidden=true></i> Top</a></div></div></div><footer id=footer><div class=footer-left>Copyright &copy; 2022 pinkhello</div><div class=footer-right><nav><ul><li><a href=/>Home</a></li><li><a href=/posts>Posts</a></li><li><a href=/categories>Category</a></li><li><a href=/tags>Tag</a></li><li><a href=/index.xml>Rss</a></li><li><a href=/jobs>Job</a></li></ul></nav></div></footer></div></body><link rel=stylesheet href=/lib/font-awesome/css/all.min.css><script src=/lib/jquery/jquery.min.js></script>
<script src=/js/main.js></script>
<script src=/js/code-copy.js></script>
<script>MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]]},svg:{fontCache:"global"}}</script><script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script></html>