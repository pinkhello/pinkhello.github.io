<!doctype html><html lang=en-us><head><link rel=preload href=/lib/font-awesome/webfonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2 as=font type=font/woff2 crossorigin=anonymous><script type=text/javascript src=https://latest.cactus.chat/cactus.js></script>
<link rel=stylesheet href=https://latest.cactus.chat/style.css type=text/css><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>å¦‚ä½•å»å®ç°RingBuffer | pinkhello</title><link rel=canonical href=https://pinkhello.cc/posts/45-%E5%A6%82%E4%BD%95%E5%8E%BB%E5%AE%9E%E7%8E%B0ringbuffer/><meta name=description content="ğŸ‘·Hey! æˆ‘æ˜¯ **pinkhello**ï¼ŒğŸ’» ä¸€ååç«¯ç¨‹åºå‘˜ã€‚**é‡è¦æç¤º**: åœ¨æ‚¨é˜…è¯»æ–‡ç« å¹¶è¯„è®ºä¹‹å‰ï¼Œè¯·å…ˆè®¤çœŸé˜…è¯»[**è¯„è®ºæ‰¿è¯º**](http://pinkhello.cc/promise)ã€‚"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><meta property="og:title" content="å¦‚ä½•å»å®ç°RingBuffer"><meta property="og:description" content="å¦‚ä½•å»å®ç°RingBuffer"><meta property="og:type" content="article"><meta property="og:url" content="https://pinkhello.cc/posts/45-%E5%A6%82%E4%BD%95%E5%8E%BB%E5%AE%9E%E7%8E%B0ringbuffer/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-02-10T14:39:59+08:00"><meta property="article:modified_time" content="2022-02-10T14:39:59+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="å¦‚ä½•å»å®ç°RingBuffer"><meta name=twitter:description content="å¦‚ä½•å»å®ç°RingBuffer"><link rel=stylesheet href=https://pinkhello.cc/css/styles.94f653e9e151e28067a7c5dbbc4600cbd5a3c721e79faaf971e523c40f3b249b8e4f20bb57810dfffa8d559ca5c140fd56eb4cd9c0853113ad08e66afdb08bdd.css integrity="sha512-lPZT6eFR4oBnp8XbvEYAy9WjxyHnn6r5ceUjxA87JJuOTyC7V4EN//qNVZylwUD9VutM2cCFMROtCOZq/bCL3Q=="><link rel=stylesheet href=https://pinkhello.cc/css/pinkhello.css><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script>
<script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel=icon type=image/png href=https://pinkhello.cc/images/favicon.ico><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','G-M2FXWC325L','auto'),ga('send','pageview'))</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body class="max-width mx-auto px3 ltr"><div class="content index py4"><div id=header-post><a id=menu-icon href=#><i class="fas fa-bars fa-lg"></i></a>
<a id=menu-icon-tablet href=#><i class="fas fa-bars fa-lg"></i></a>
<a id=top-icon-tablet href=# onclick="$('html, body').animate({scrollTop:0},'fast')" style=display:none aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg"></i></a>
<span id=menu><span id=nav><ul><li><a href=/>Home</a></li><li><a href=/posts>Posts</a></li><li><a href=/categories>Category</a></li><li><a href=/tags>Tag</a></li><li><a href=/index.xml>Rss</a></li><li><a href=/jobs>Job</a></li></ul></span><br><span id=actions><ul><li><a class=icon href=https://pinkhello.cc/posts/43-golang%E7%9A%84%E6%B1%A0%E5%8C%96%E8%AE%BE%E8%AE%A1/ aria-label=Previous><i class="fas fa-chevron-left" aria-hidden=true onmouseover="$('#i-prev').toggle()" onmouseout="$('#i-prev').toggle()"></i></a></li><li><a class=icon href=https://pinkhello.cc/posts/46-lrucache-%E5%AE%9E%E7%8E%B0/ aria-label=Next><i class="fas fa-chevron-right" aria-hidden=true onmouseover="$('#i-next').toggle()" onmouseout="$('#i-next').toggle()"></i></a></li><li><a class=icon href=# onclick="$('html, body').animate({scrollTop:0},'fast')" aria-label="Top of Page"><i class="fas fa-chevron-up" aria-hidden=true onmouseover="$('#i-top').toggle()" onmouseout="$('#i-top').toggle()"></i></a></li><li><a class=icon href=# aria-label=Share><i class="fas fa-share-alt" aria-hidden=true onmouseover="$('#i-share').toggle()" onmouseout="$('#i-share').toggle()" onclick="return $('#share').toggle(),!1"></i></a></li></ul><span id=i-prev class=info style=display:none>Previous post</span>
<span id=i-next class=info style=display:none>Next post</span>
<span id=i-top class=info style=display:none>Back to top</span>
<span id=i-share class=info style=display:none>Share post</span></span><br><div id=share style=display:none><ul><li><a class=icon href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fpinkhello.cc%2fposts%2f45-%25E5%25A6%2582%25E4%25BD%2595%25E5%258E%25BB%25E5%25AE%259E%25E7%258E%25B0ringbuffer%2f" aria-label=Facebook><i class="fab fa-facebook" aria-hidden=true></i></a></li><li><a class=icon href="https://twitter.com/share?url=https%3a%2f%2fpinkhello.cc%2fposts%2f45-%25E5%25A6%2582%25E4%25BD%2595%25E5%258E%25BB%25E5%25AE%259E%25E7%258E%25B0ringbuffer%2f&text=%e5%a6%82%e4%bd%95%e5%8e%bb%e5%ae%9e%e7%8e%b0RingBuffer" aria-label=Twitter><i class="fab fa-twitter" aria-hidden=true></i></a></li><li><a class=icon href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fpinkhello.cc%2fposts%2f45-%25E5%25A6%2582%25E4%25BD%2595%25E5%258E%25BB%25E5%25AE%259E%25E7%258E%25B0ringbuffer%2f&title=%e5%a6%82%e4%bd%95%e5%8e%bb%e5%ae%9e%e7%8e%b0RingBuffer" aria-label=Linkedin><i class="fab fa-linkedin" aria-hidden=true></i></a></li><li><a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fpinkhello.cc%2fposts%2f45-%25E5%25A6%2582%25E4%25BD%2595%25E5%258E%25BB%25E5%25AE%259E%25E7%258E%25B0ringbuffer%2f&is_video=false&description=%e5%a6%82%e4%bd%95%e5%8e%bb%e5%ae%9e%e7%8e%b0RingBuffer" aria-label=Pinterest><i class="fab fa-pinterest" aria-hidden=true></i></a></li><li><a class=icon href="mailto:?subject=%e5%a6%82%e4%bd%95%e5%8e%bb%e5%ae%9e%e7%8e%b0RingBuffer&body=Check out this article: https%3a%2f%2fpinkhello.cc%2fposts%2f45-%25E5%25A6%2582%25E4%25BD%2595%25E5%258E%25BB%25E5%25AE%259E%25E7%258E%25B0ringbuffer%2f" aria-label=Email><i class="fas fa-envelope" aria-hidden=true></i></a></li><li><a class=icon href="https://getpocket.com/save?url=https%3a%2f%2fpinkhello.cc%2fposts%2f45-%25E5%25A6%2582%25E4%25BD%2595%25E5%258E%25BB%25E5%25AE%259E%25E7%258E%25B0ringbuffer%2f&title=%e5%a6%82%e4%bd%95%e5%8e%bb%e5%ae%9e%e7%8e%b0RingBuffer" aria-label=Pocket><i class="fab fa-get-pocket" aria-hidden=true></i></a></li><li><a class=icon href="http://reddit.com/submit?url=https%3a%2f%2fpinkhello.cc%2fposts%2f45-%25E5%25A6%2582%25E4%25BD%2595%25E5%258E%25BB%25E5%25AE%259E%25E7%258E%25B0ringbuffer%2f&title=%e5%a6%82%e4%bd%95%e5%8e%bb%e5%ae%9e%e7%8e%b0RingBuffer" aria-label=reddit><i class="fab fa-reddit" aria-hidden=true></i></a></li><li><a class=icon href="http://www.tumblr.com/share/link?url=https%3a%2f%2fpinkhello.cc%2fposts%2f45-%25E5%25A6%2582%25E4%25BD%2595%25E5%258E%25BB%25E5%25AE%259E%25E7%258E%25B0ringbuffer%2f&name=%e5%a6%82%e4%bd%95%e5%8e%bb%e5%ae%9e%e7%8e%b0RingBuffer&description=%e5%a6%82%e4%bd%95%e5%8e%bb%e5%ae%9e%e7%8e%b0RingBuffer" aria-label=Tumblr><i class="fab fa-tumblr" aria-hidden=true></i></a></li><li><a class=icon href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fpinkhello.cc%2fposts%2f45-%25E5%25A6%2582%25E4%25BD%2595%25E5%258E%25BB%25E5%25AE%259E%25E7%258E%25B0ringbuffer%2f&t=%e5%a6%82%e4%bd%95%e5%8e%bb%e5%ae%9e%e7%8e%b0RingBuffer" aria-label="Hacker News"><i class="fab fa-hacker-news" aria-hidden=true></i></a></li></ul></div></span></div><article class=post itemscope itemtype=http://schema.org/BlogPosting><header><h1 class=posttitle itemprop="name headline">å¦‚ä½•å»å®ç°RingBuffer</h1><div class=meta><div class=postdate><time datetime="2022-02-10 14:39:59 +0800 +0800" itemprop=datePublished>2022-02-10</time></div><div class=article-category><i class="fas fa-archive"></i>
<a class=category-link href=/categories/tech>Tech</a></div><div class=article-tag><i class="fas fa-tag"></i>
<a class=tag-link href=/tags/algorithms rel=tag>Algorithms</a></div></div></header><div id=toc><nav id=TableOfContents><ul><li><a href=#å®ç°å®ƒçš„æ–¹å¼>å®ç°å®ƒçš„æ–¹å¼</a></li><li><a href=#è®¨è®º-ringbuffer-çš„è¿è¡Œæ–¹å¼>è®¨è®º ringbuffer çš„è¿è¡Œæ–¹å¼</a></li><li><a href=#empty-buffer-å’Œ-full-buffer>Empty Buffer å’Œ Full Buffer</a><ul><li><a href=#empty-buffer-åˆ¤å®š>Empty Buffer åˆ¤å®š</a></li><li><a href=#full-buffer-åˆ¤å®š>Full Buffer åˆ¤å®š</a></li></ul></li></ul><ul><li><a href=#å®šä¹‰>å®šä¹‰</a></li><li><a href=#offer-æ’å…¥>offer æ’å…¥</a></li><li><a href=#poll-è¯»å–>poll è¯»å–</a></li><li><a href=#ut>UT</a></li><li><a href=#çº¿ç¨‹å®‰å…¨çš„>çº¿ç¨‹å®‰å…¨çš„</a></li></ul></nav></div><div class=content itemprop=articleBody><h1 id=æ–‡å¼•>æ–‡å¼•</h1><p><code>RingBuffer</code>, åå¦‚å…¶æ„: <code>ç¯å½¢ç¼“å­˜åŒº</code>/<code>ç¯å½¢é˜Ÿåˆ—</code>ï¼Œä¸åŒäºä¸€èˆ¬çš„é˜Ÿåˆ—ï¼Œç‰¹å¾æ˜¯é¦–å°¾ç›¸æ¥ã€‚</p><h1 id=ringbuffer-å¦‚ä½•å·¥ä½œçš„><code>RingBuffer</code> å¦‚ä½•å·¥ä½œçš„</h1><p><code>RingBuffer</code> æ˜¯ä¸€ä¸ªæœ‰ç•Œçš„å¾ªç¯çš„æ•°æ®ç»“æ„ï¼Œä¸»è¦ç”¨äºå¤šçº¿ç¨‹ä¸‹è¿›è¡Œçš„æ•°æ®ç¼“å­˜ã€‚åœ¨æŒç»­çš„å†™å…¥æ•°æ®çš„æ—¶å€™ï¼Œåˆ°è¾¾æœ«å°¾çš„æ—¶å€™é“¾æ¥åˆ°å¤´ï¼Œæ•ˆæœä¸Šè¾¾æˆä¸€ä¸ªç¯çŠ¶ã€‚</p><h2 id=å®ç°å®ƒçš„æ–¹å¼>å®ç°å®ƒçš„æ–¹å¼</h2><p>å®ƒæ˜¯æœ‰ç•Œçš„æ•°ç»„å®ç°ï¼Œå¦‚å›¾ã€‚</p><p><img src=/ringbuffer/%E6%95%B0%E7%BB%84%E5%AE%9E%E7%8E%B0ringbuffer.png alt=ringbufferæ•°ç»„å®ç°></p><p>è€Œä¸”æˆ‘ä»¬è¿˜è¦å…³æ³¨åˆ° <code>readeræŒ‡é’ˆ</code> ã€ <code>writeræŒ‡é’ˆ</code>ã€ å¤´å°¾ç›¸è¿</p><ul><li><code>reader pointer</code> ä¸‹ä¸€ä¸ªå¯è¯»å…ƒç´ </li><li><code>writer pointer</code> ä¸‹ä¸€ä¸ªå¯æ’å…¥çš„å…ƒç´  <code>slot</code></li><li>æ•°ç»„å¤´ å’Œ æ•°ç»„å°¾ ç›¸äº’é“¾æ¥</li></ul><h2 id=è®¨è®º-ringbuffer-çš„è¿è¡Œæ–¹å¼>è®¨è®º ringbuffer çš„è¿è¡Œæ–¹å¼</h2><p><code>ringbuffer</code> çš„å…³é”®å‚æ•°, <code>read seq</code> & <code>write seq</code></p><ul><li><code>reader pointer seq</code> => ä» <code>0</code> å¼€å§‹ï¼Œéšç€è¯»å–æ¶ˆè€—ä¸€ä¸ªå…ƒç´  <code>+1</code></li><li><code>writer pointer seq</code> => ä» <code>-1</code> å¼€å§‹ï¼Œæ’å…¥ä¸€ä¸ªå…ƒç´ æ—¶å€™ <code>+1</code></li></ul><p><img src=/ringbuffer/ringbuffer%E7%9A%84%E6%89%A7%E8%A1%8C.png alt=ringbufferè·å–æ•°ç»„Index></p><p>å¯ä»¥çœ‹å‡ºä¸¤ç§ <code>Seq</code> å¯¹ å®¹é‡è¿›è¡Œ <code>Mod</code> æ“ä½œå¯ä»¥å°† <code>seq</code> æ˜ å°„åˆ° <code>ringbuffer</code> çš„ <code>index</code> ä¸Š.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span> array_index <span style=color:#f92672>=</span> seq % capacity
</span></span></code></pre></div><p>åŸºäºä¸Šé¢çš„æ€æƒ³ï¼Œæˆ‘ä»¬çœ‹ <code>ringbuffer</code> çš„æ ¸å¿ƒæ“ä½œ</p><ul><li>æ’å…¥å…ƒç´  <code>buffer[++writeSeq % capacity] = element</code>, åœ¨æ’å…¥å…ƒç´ æ—¶å€™å…ˆå°† <code>writeSeq + 1</code>, ç„¶å<code>Modæ“ä½œ</code> æ’å…¥å…ƒç´ </li><li>æ¶ˆè´¹å…ƒç´  <code>element = buffer[readSeq++ % capacity]</code>, å…ˆè·å–å…ƒç´ ï¼Œå† <code>redSeq + 1</code> =ã€‹ <code>reqSeq</code> æŒ‡å‘ä¸‹ä¸€ä¸ª <code>Slot</code></li></ul><blockquote><p>æ¶ˆè´¹å…ƒç´ ï¼Œè¢«æ¶ˆè´¹çš„å…ƒç´ å¹¶ä¸ä¼šè¢«åˆ é™¤ï¼Œè€Œæ˜¯ä¿ç•™åœ¨æ•°ç»„ä¸­ï¼Œç›´åˆ°ä¸‹æ¬¡è¢«è¦†ç›–ã€‚</p></blockquote><h2 id=empty-buffer-å’Œ-full-buffer>Empty Buffer å’Œ Full Buffer</h2><p>æˆ‘ä»¬è¦ä½¿ç”¨ <code>RingBuffer</code> çš„æ—¶å€™ï¼Œå› ä¸ºæ˜¯ç¯å½¢çš„ï¼Œå¯èƒ½å‡ºç° <code>writer pointer</code> è¿½ä¸Š <code>reader pointer</code> çš„æƒ…å†µã€‚
è¿™æ—¶å€™éœ€è¦åŒºåˆ†åœºæ™¯æ¥å¤„ç†ã€‚</p><ul><li>å¦‚æœæ•°æ®æ˜¯æ—§çš„å€¼æˆ–è€…ä¸­é—´å€¼(e.g:è‚¡ç¥¨ä»£ç ä»·æ ¼), å¯ä»¥ç›´æ¥è¦†ç›–æ•°æ®ï¼Œä¸ç”¨ç­‰å¾…æ•°æ®è¢«æ¶ˆè´¹ã€‚</li><li>å¦‚æœ <code>Reader Pointer</code> å¿…é¡»æ¶ˆè´¹ <code>Buffer</code> ä¸­æ‰€æœ‰çš„æ—§å€¼ï¼ˆe.g:ç”µå•†äº¤æ˜“ï¼‰,é‚£å°±éœ€è¦åš <code>waiting</code>ï¼ˆé˜»å¡ç­‰ç­‰ï¼‰ï¼Œç›´åˆ°<code>Buffer</code>æœ‰å¯ç”¨çš„æ“åšçš„ <code>slot</code>.</li></ul><h3 id=empty-buffer-åˆ¤å®š>Empty Buffer åˆ¤å®š</h3><blockquote><p>Writer Seq æ¯” Reader Seq å°, åˆ™ ç¼“å†²åŒºä¸ºç©º</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span> isEmpty <span style=color:#f92672>=</span> writerSeq &lt; readSeq
</span></span></code></pre></div><p><img src=/ringbuffer/empty-buffer.png alt=empty-buffer></p><h3 id=full-buffer-åˆ¤å®š>Full Buffer åˆ¤å®š</h3><blockquote><p>Buffer Size å’Œ Capacity ç›¸ç­‰ï¼Œç¼“å†²åŒºå·²æ»¡ï¼Œå¤§å°ç­‰äºæœªè¯»å…ƒç´ çš„æ•°é‡</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span> size <span style=color:#f92672>=</span> writerSeq - readSeq + <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span> isFull <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>size <span style=color:#f92672>==</span> capacity<span style=color:#f92672>)</span>
</span></span></code></pre></div><p><img src=/ringbuffer/full-buffer.png alt=empty-buffer></p><h1 id=ringbuffer-çš„ä¼˜ç¼ºç‚¹>RingBuffer çš„ä¼˜ç¼ºç‚¹</h1><p>RingBuffer ä¼˜ç‚¹:</p><ul><li>é«˜æ•ˆçš„ FIFO ç¼“å†²åŒºï¼Œé¢„åˆ†é…å›ºå®šå¤§å°çš„æ•°ç»„ï¼Œé«˜æ•ˆç‡çš„å†…å­˜è®¿é—®æ¨¡å¼ã€‚</li><li>Buffer çš„æ“ä½œæ—¶é—´å¤æ‚åº¦éƒ½æ˜¯ O(1)ï¼ˆç‰¹åˆ«æ¶ˆè€—å…ƒç´ ã€ä¸éœ€è¦ç§»åŠ¨å…ƒç´ ï¼‰</li></ul><p>RingBuffer ç¼ºç‚¹:</p><ul><li>è®¾ç½® Buffer çš„å¤§å°è‡³å…³é‡è¦ï¼Œ ç¼“å†²åŒºè¿‡å°ï¼Œè¯»å–é€Ÿåº¦æ…¢ï¼Œå†™å…¥æ“ä½œé˜»å¡å¾ˆé•¿ã€‚</li><li>å½“åŠ¨æ€è°ƒæ•´çš„æ—¶å€™ï¼Œéœ€è¦ç§»åŠ¨æ•°æ®</li></ul><h1 id=ä»£ç å®ç°>ä»£ç å®ç°</h1><h2 id=å®šä¹‰>å®šä¹‰</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>CircularBuffer</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> capacity<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>capacity</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>capacity <span style=color:#f92672>&lt;</span> 1<span style=color:#f92672>)</span> <span style=color:#f92672>?</span> DEFAULT_CAPACITY <span style=color:#f92672>:</span> capacity<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>data</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>E<span style=color:#f92672>[])</span> <span style=color:#66d9ef>new</span> Object<span style=color:#f92672>[</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>capacity</span><span style=color:#f92672>];</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>readSeq</span> <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>writeSeq</span> <span style=color:#f92672>=</span> <span style=color:#f92672>-</span>1<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=offer-æ’å…¥>offer æ’å…¥</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>offer</span><span style=color:#f92672>(</span>E element<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>boolean</span> isFull <span style=color:#f92672>=</span> writeSeq <span style=color:#f92672>-</span> readSeq <span style=color:#f92672>+</span> 1 <span style=color:#f92672>==</span> capacity<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>isFull<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>int</span> nextWriteSeq <span style=color:#f92672>=</span> writeSeq <span style=color:#f92672>+</span> 1<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            data<span style=color:#f92672>[</span>nextWriteSeq <span style=color:#f92672>%</span> capacity<span style=color:#f92672>]</span> <span style=color:#f92672>=</span> element<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            writeSeq<span style=color:#f92672>++;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    
</span></span></code></pre></div><h2 id=poll-è¯»å–>poll è¯»å–</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#66d9ef>public</span> E <span style=color:#a6e22e>poll</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>boolean</span> isEmpty <span style=color:#f92672>=</span> writeSeq <span style=color:#f92672>&lt;</span> readSeq<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>isEmpty<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            E nextElement <span style=color:#f92672>=</span> data<span style=color:#f92672>[</span>readSeq <span style=color:#f92672>%</span> capacity<span style=color:#f92672>];</span>
</span></span><span style=display:flex><span>            readSeq<span style=color:#f92672>++;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> nextElement<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=ut>UT</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#a6e22e>@BeforeEach</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>initBuffer</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        buffer <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> CircularBuffer<span style=color:#f92672>(</span>10<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        assertTrue<span style=color:#f92672>(</span>buffer<span style=color:#f92672>.</span><span style=color:#a6e22e>offer</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Wocao&#34;</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>testOffer</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        assertTrue<span style=color:#f92672>(</span>buffer<span style=color:#f92672>.</span><span style=color:#a6e22e>offer</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;mmp&#34;</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>        assertEquals<span style=color:#f92672>(</span>2<span style=color:#f92672>,</span> buffer<span style=color:#f92672>.</span><span style=color:#a6e22e>size</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>testPoll</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        assertTrue<span style=color:#f92672>(</span>buffer<span style=color:#f92672>.</span><span style=color:#a6e22e>offer</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;mmp2&#34;</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>        assertEquals<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Wocao&#34;</span><span style=color:#f92672>,</span> buffer<span style=color:#f92672>.</span><span style=color:#a6e22e>poll</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        assertEquals<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;mmp2&#34;</span><span style=color:#f92672>,</span> buffer<span style=color:#f92672>.</span><span style=color:#a6e22e>poll</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=çº¿ç¨‹å®‰å…¨çš„>çº¿ç¨‹å®‰å…¨çš„</h2><p>è¿™è¾¹åªè€ƒè™‘ å•ä¸€ç”Ÿäº§è€…å’Œå•ä¸€æ¶ˆè´¹è€…æƒ…å†µï¼Œ æ‰€ä»¥åœ¨æ•°ç»„ä¸Šæ— äº‰ç”¨ï¼Œå¯ä»¥ä¸ä½¿ç”¨é”ã€‚åªéœ€è¦ä¿è¯ ä¸¤ä¸ª <code>Seq</code> çš„å¯è§æ€§</p><ul><li><code>producer</code> ç”Ÿäº§æ•°æ®å†™å…¥ <code>buffer</code> å¹¶å¢åŠ  <code>writeSeq</code></li><li><code>consumer</code> ä» <code>buffer</code> æ¶ˆè´¹æ•°æ®ï¼Œå¹¶å¢åŠ  <code>readSeq</code></li></ul><p>åªéœ€è¦ç»™ <code>writeSeq</code> ï¼Œ<code>readSeq</code> ä¿è¯ <code>volatile</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>volatile</span> <span style=color:#66d9ef>int</span> readSeq <span style=color:#f92672>=</span> 0<span style=color:#f92672>,</span> writeSeq <span style=color:#f92672>=</span> <span style=color:#f92672>-</span>1<span style=color:#f92672>;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    CircularBuffer buffer <span style=color:#f92672>=</span>  <span style=color:#66d9ef>new</span> CircularBuffer<span style=color:#f92672>(</span>5<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>testProducerConsumer</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>new</span> Thread<span style=color:#f92672>(()</span> <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> i <span style=color:#f92672>&lt;</span> 10<span style=color:#f92672>;)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>buffer<span style=color:#f92672>.</span><span style=color:#a6e22e>offer</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;element:&#34;</span> <span style=color:#f92672>+</span> i<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;produced &#34;</span> <span style=color:#f92672>+</span> i <span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    i<span style=color:#f92672>++;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}).</span><span style=color:#a6e22e>start</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>new</span> Thread<span style=color:#f92672>(()</span> <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span>0<span style=color:#f92672>;</span> i <span style=color:#f92672>&lt;</span> 10<span style=color:#f92672>;</span> <span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                String c <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>String<span style=color:#f92672>)</span> buffer<span style=color:#f92672>.</span><span style=color:#a6e22e>poll</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span> c <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;consumed:&#34;</span> <span style=color:#f92672>+</span> c<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}).</span><span style=color:#a6e22e>start</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            Thread<span style=color:#f92672>.</span><span style=color:#a6e22e>sleep</span><span style=color:#f92672>(</span>5000<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>InterruptedException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            e<span style=color:#f92672>.</span><span style=color:#a6e22e>printStackTrace</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>è¾“å‡º</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>produced <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>produced <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>produced <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>produced <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>produced <span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span>produced <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>consumed:element:0
</span></span><span style=display:flex><span>consumed:element:1
</span></span><span style=display:flex><span>consumed:element:2
</span></span><span style=display:flex><span>produced <span style=color:#ae81ff>6</span>
</span></span><span style=display:flex><span>consumed:element:3
</span></span><span style=display:flex><span>produced <span style=color:#ae81ff>7</span>
</span></span><span style=display:flex><span>consumed:element:4
</span></span><span style=display:flex><span>produced <span style=color:#ae81ff>8</span>
</span></span><span style=display:flex><span>consumed:element:5
</span></span><span style=display:flex><span>consumed:element:6
</span></span><span style=display:flex><span>consumed:element:7
</span></span><span style=display:flex><span>consumed:element:8
</span></span><span style=display:flex><span>consumed:element:9
</span></span><span style=display:flex><span>produced <span style=color:#ae81ff>9</span>
</span></span></code></pre></div><p>å¯ä»¥çœ‹å‡ºï¼Œå½“ç”Ÿäº§è€…çº¿ç¨‹å‘ç°æ— æ³•å†™å…¥çš„æ—¶å€™ï¼ˆåœ¨ å¾ªç¯ä¸­ ç­‰å¾…ä¸€ä¸ªç©ºçš„ slotï¼‰ï¼Œæ¶ˆè´¹è€…çº¿ç¨‹ä» buffer ä¸­è·å–åˆ° nullï¼Œç»§ç»­æ‰§è¡Œï¼Œä¸æ‰“å°ã€‚</p><p>ä¸Šé¢ä»£ç å®ç°åœ¨ <a href=https://github.com/pinkhello/blog-code/blob/main/j-code>github ä»£ç </a></p></div></article><div class=blog-post-comments><div id=disqus_thread><script type=text/javascript>(function(){var t,e=document.createElement('script');e.type='text/javascript',e.async=!0,t='pinkhello',e.src='//'+t+'.disqus.com/embed.js',(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(e)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com/ class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div><div id=footer-post-container><div id=footer-post><div id=nav-footer style=display:none><ul><li><a href=/>Home</a></li><li><a href=/posts>Posts</a></li><li><a href=/categories>Category</a></li><li><a href=/tags>Tag</a></li><li><a href=/index.xml>Rss</a></li><li><a href=/jobs>Job</a></li></ul></div><div id=share-footer style=display:none><ul><li><a class=icon href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fpinkhello.cc%2fposts%2f45-%25E5%25A6%2582%25E4%25BD%2595%25E5%258E%25BB%25E5%25AE%259E%25E7%258E%25B0ringbuffer%2f" aria-label=Facebook><i class="fab fa-facebook fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://twitter.com/share?url=https%3a%2f%2fpinkhello.cc%2fposts%2f45-%25E5%25A6%2582%25E4%25BD%2595%25E5%258E%25BB%25E5%25AE%259E%25E7%258E%25B0ringbuffer%2f&text=%e5%a6%82%e4%bd%95%e5%8e%bb%e5%ae%9e%e7%8e%b0RingBuffer" aria-label=Twitter><i class="fab fa-twitter fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fpinkhello.cc%2fposts%2f45-%25E5%25A6%2582%25E4%25BD%2595%25E5%258E%25BB%25E5%25AE%259E%25E7%258E%25B0ringbuffer%2f&title=%e5%a6%82%e4%bd%95%e5%8e%bb%e5%ae%9e%e7%8e%b0RingBuffer" aria-label=Linkedin><i class="fab fa-linkedin fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fpinkhello.cc%2fposts%2f45-%25E5%25A6%2582%25E4%25BD%2595%25E5%258E%25BB%25E5%25AE%259E%25E7%258E%25B0ringbuffer%2f&is_video=false&description=%e5%a6%82%e4%bd%95%e5%8e%bb%e5%ae%9e%e7%8e%b0RingBuffer" aria-label=Pinterest><i class="fab fa-pinterest fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="mailto:?subject=%e5%a6%82%e4%bd%95%e5%8e%bb%e5%ae%9e%e7%8e%b0RingBuffer&body=Check out this article: https%3a%2f%2fpinkhello.cc%2fposts%2f45-%25E5%25A6%2582%25E4%25BD%2595%25E5%258E%25BB%25E5%25AE%259E%25E7%258E%25B0ringbuffer%2f" aria-label=Email><i class="fas fa-envelope fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://getpocket.com/save?url=https%3a%2f%2fpinkhello.cc%2fposts%2f45-%25E5%25A6%2582%25E4%25BD%2595%25E5%258E%25BB%25E5%25AE%259E%25E7%258E%25B0ringbuffer%2f&title=%e5%a6%82%e4%bd%95%e5%8e%bb%e5%ae%9e%e7%8e%b0RingBuffer" aria-label=Pocket><i class="fab fa-get-pocket fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://reddit.com/submit?url=https%3a%2f%2fpinkhello.cc%2fposts%2f45-%25E5%25A6%2582%25E4%25BD%2595%25E5%258E%25BB%25E5%25AE%259E%25E7%258E%25B0ringbuffer%2f&title=%e5%a6%82%e4%bd%95%e5%8e%bb%e5%ae%9e%e7%8e%b0RingBuffer" aria-label=reddit><i class="fab fa-reddit fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.tumblr.com/share/link?url=https%3a%2f%2fpinkhello.cc%2fposts%2f45-%25E5%25A6%2582%25E4%25BD%2595%25E5%258E%25BB%25E5%25AE%259E%25E7%258E%25B0ringbuffer%2f&name=%e5%a6%82%e4%bd%95%e5%8e%bb%e5%ae%9e%e7%8e%b0RingBuffer&description=%e5%a6%82%e4%bd%95%e5%8e%bb%e5%ae%9e%e7%8e%b0RingBuffer" aria-label=Tumblr><i class="fab fa-tumblr fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fpinkhello.cc%2fposts%2f45-%25E5%25A6%2582%25E4%25BD%2595%25E5%258E%25BB%25E5%25AE%259E%25E7%258E%25B0ringbuffer%2f&t=%e5%a6%82%e4%bd%95%e5%8e%bb%e5%ae%9e%e7%8e%b0RingBuffer" aria-label="Hacker News"><i class="fab fa-hacker-news fa-lg" aria-hidden=true></i></a></li></ul></div><div id=actions-footer><a id=menu-toggle class=icon href=# onclick="return $('#nav-footer').toggle(),!1" aria-label=Menu><i class="fas fa-bars fa-lg" aria-hidden=true></i> Menu</a>
<a id=share-toggle class=icon href=# onclick="return $('#share-footer').toggle(),!1" aria-label=Share><i class="fas fa-share-alt fa-lg" aria-hidden=true></i> share</a>
<a id=top style=display:none class=icon href=# onclick="$('html, body').animate({scrollTop:0},'fast')" aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg" aria-hidden=true></i> Top</a></div></div></div><footer id=footer><div class=footer-left>Copyright &copy; 2022 pinkhello</div><div class=footer-right><nav><ul><li><a href=/>Home</a></li><li><a href=/posts>Posts</a></li><li><a href=/categories>Category</a></li><li><a href=/tags>Tag</a></li><li><a href=/index.xml>Rss</a></li><li><a href=/jobs>Job</a></li></ul></nav></div></footer></div></body><link rel=stylesheet href=/lib/font-awesome/css/all.min.css><script src=/lib/jquery/jquery.min.js></script>
<script src=/js/main.js></script>
<script src=/js/code-copy.js></script>
<script>MathJax={tex:{inlineMath:[['$','$'],['\\(','\\)']]},svg:{fontCache:'global'}}</script><script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script></html>